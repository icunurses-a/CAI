<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LABORATORY FINAL</title>
    <style>
        :root {
            --gold: #d4af37;
            --gold-light: #f3e5ab;
            --gold-dark: #aa8c2c;
            --black: #050505;
            --dark-grey: #1a1a1a;
            --green: #2ecc71;
            --red: #e74c3c;
            --glass: rgba(20, 20, 20, 0.9);
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Cinzel', 'Segoe UI', serif;
            background-color: var(--black);
            background-image: radial-gradient(circle at 50% 50%, #222 0%, #000 100%);
            color: var(--gold);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* --- Animations --- */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        @keyframes rgb-flow {
            0% { color: #ff0000; text-shadow: 0 0 10px #ff0000, 2px 2px 0px #000; }
            25% { color: #00ff00; text-shadow: 0 0 10px #00ff00, 2px 2px 0px #000; }
            50% { color: #0000ff; text-shadow: 0 0 10px #0000ff, 2px 2px 0px #000; }
            75% { color: #ffff00; text-shadow: 0 0 10px #ffff00, 2px 2px 0px #000; }
            100% { color: #00ffff; text-shadow: 0 0 10px #00ffff, 2px 2px 0px #000; }
        }

        @keyframes wavy {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* --- Title Styles --- */
        .main-title {
            font-size: 2.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
            text-align: center;
        }
        .final-text {
            display: inline-block;
            animation: shake 0.5s infinite, rgb-flow 2s infinite alternate;
            font-weight: 900;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.8);
            padding: 0 10px;
        }

        /* --- Gold Design Elements --- */
        .gold-text {
            background: linear-gradient(to right, var(--gold-dark), var(--gold), var(--gold-light), var(--gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0px 2px 4px rgba(0,0,0,0.5);
        }

        .gold-border {
            border: 2px solid var(--gold);
            box-shadow: 0 0 10px var(--gold-dark), inset 0 0 5px var(--gold-dark);
            border-radius: 8px;
        }

        .gold-btn {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold), var(--gold-dark));
            border: 1px solid #fff;
            color: #000;
            padding: 10px 20px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px var(--gold-dark);
            border-radius: 4px;
        }

        .gold-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px var(--gold);
        }

        .gold-btn:active {
            transform: scale(0.95);
        }

        .red-btn {
            background: linear-gradient(135deg, #800, #f00, #800);
            color: white;
            border-color: #ff8888;
        }

        /* --- Scanning Line --- */
        #scanner-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 215, 0, 0.8);
            box-shadow: 0 0 10px var(--gold);
            z-index: 1000;
            pointer-events: none;
            display: none;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .scanning #scanner-line {
            display: block;
            animation: scan 3s linear infinite;
        }

        /* --- Layout --- */
        header {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.8);
            border-bottom: 1px solid var(--gold-dark);
            z-index: 10;
        }

        .hud-stats {
            display: flex;
            gap: 20px;
            font-size: 1.1rem;
            align-items: center;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 5;
            padding: 20px;
            overflow: hidden;
        }

        /* --- Screens --- */
        .screen {
            display: none;
            width: 100%;
            max-width: 800px;
            height: 100%;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Menu --- */
        .menu-card {
            background: var(--glass);
            padding: 40px;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        .mode-select {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }

        .input-group {
            margin: 20px 0;
            color: var(--gold);
        }
        .input-group input {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 5px;
            width: 60px;
            text-align: center;
            font-size: 1.2rem;
        }

        /* --- Quiz Interface --- */
        .quiz-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .question-card {
            background: var(--glass);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.2rem;
            position: relative;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--gold-dark);
            color: var(--gold-light);
            padding: 15px;
            text-align: left;
            cursor: pointer;
            transition: 0.2s;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .option-btn.correct {
            background: rgba(46, 204, 113, 0.3);
            border-color: var(--green);
            color: #fff;
        }

        .option-btn.wrong {
            background: rgba(231, 76, 60, 0.3);
            border-color: var(--red);
            color: #fff;
        }

        .feedback-area {
            min-height: 60px;
            margin-top: 10px;
            text-align: center;
            color: #fff;
            font-size: 0.9rem;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            display: none;
        }

        .quiz-footer {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            flex-wrap: wrap;
            gap: 10px;
        }

        .navigator {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            max-width: 60%;
            overflow-y: auto;
            max-height: 60px;
        }

        .nav-dot {
            width: 25px;
            height: 25px;
            border: 1px solid var(--gold-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 0.8rem;
            color: #555;
            flex-shrink: 0;
        }

        .nav-dot.active { border-color: var(--gold); color: var(--gold); }
        .nav-dot.completed { background: var(--gold-dark); color: #000; border-color: var(--gold); }
        .nav-dot.correct { background: var(--green); border-color: var(--green); color: white; }
        .nav-dot.wrong { background: var(--red); border-color: var(--red); color: white; }

        /* --- Alien Pet --- */
        #alien-pet {
            position: absolute;
            width: 80px;
            height: 80px;
            font-size: 60px;
            cursor: grab;
            z-index: 999;
            filter: drop-shadow(0 0 10px var(--gold));
            transition: transform 0.1s;
            top: 80%;
            left: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #alien-pet:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        /* --- Visual Effects --- */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: floatUp 1.5s ease-out forwards;
            font-size: 20px;
            z-index: 1001;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }

        .emoji-effect {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            animation: popFade 1s ease-out forwards;
            z-index: 1002;
        }

        @keyframes popFade {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
            100% { transform: scale(1) rotate(360deg); opacity: 0; top: -50px; }
        }

        /* Toggle Switch */
        .switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--gold);
            font-size: 0.9rem;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 20px;
            border: 1px solid var(--gold-dark);
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 2px;
            bottom: 2px;
            background-color: var(--gold);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--gold-dark); }
        input:checked + .slider:before { transform: translateX(20px); background-color: #fff; }

        /* Timer */
        .timer {
            font-family: monospace;
            font-size: 1.5rem;
            color: var(--gold);
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 10px;
            font-size: 0.8rem;
            background: rgba(0,0,0,0.9);
            border-top: 1px solid #333;
            z-index: 10;
        }
        .copyright-text {
            font-family: monospace;
            font-weight: bold;
            text-transform: uppercase;
            animation: wavy 2s ease-in-out infinite, rgb-flow 3s linear infinite;
        }
    </style>
</head>
<body>

    <div id="scanner-line"></div>

    <header>
        <div style="font-weight: bold; font-size: 1rem; color: #888;">LAB SYSTEM v1.0</div>
        
        <div class="hud-stats">
            <div class="switch-container">
                <span>Scan</span>
                <label class="switch">
                    <input type="checkbox" id="scan-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="stat-item">ü™ô <span id="coin-display">0</span></div>
            <div class="stat-item">‚≠ê <span id="score-display">0</span></div>
        </div>
    </header>

    <main>
        <!-- ALIEN PET -->
        <div id="alien-pet">üëæ</div>

        <!-- START SCREEN -->
        <div id="start-screen" class="screen active">
            <div class="menu-card gold-border">
                <h1 class="main-title">Laboratory <span class="final-text">FINAL</span></h1>
                <p style="font-style:italic; color:#aaa;">Master the Immune System, Blood, & Genetics</p>
                
                <div class="input-group">
                    <label for="q-count">Number of Questions (1-200): </label>
                    <input type="number" id="q-count" min="1" max="200" value="50">
                </div>

                <div class="mode-select">
                    <button class="gold-btn" onclick="startQuiz('study')">Study Mode</button>
                    <button class="gold-btn" onclick="startQuiz('exam')">Exam Mode</button>
                </div>

                <div style="margin-top: 20px; font-size: 0.8rem; color: #666;">
                    <p>üîä Sound FX Enabled</p>
                    <p>üëæ Drag the Alien for luck</p>
                </div>
            </div>
        </div>

        <!-- QUIZ SCREEN -->
        <div id="quiz-screen" class="screen">
            <div class="quiz-container">
                <div class="quiz-footer" style="margin-bottom: 10px; justify-content: space-between;">
                    <div>Q: <span id="q-current">1</span> / <span id="q-total">50</span></div>
                    <div id="timer-display" class="timer">00:00</div>
                </div>

                <div class="question-card gold-border">
                    <p id="question-text">Loading...</p>
                </div>

                <div id="options-container" class="options-grid">
                    <!-- Options injected here -->
                </div>

                <div id="feedback-box" class="feedback-area"></div>

                <div class="quiz-footer">
                    <div class="navigator" id="nav-dots">
                        <!-- Dots injected here -->
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="end-test-btn" class="gold-btn red-btn" onclick="finishQuiz()">End Test</button>
                        <button id="next-btn" class="gold-btn" onclick="nextQuestion()">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="screen">
            <div class="menu-card gold-border">
                <h1 class="gold-text">MISSION COMPLETE</h1>
                <div style="font-size: 4rem; margin: 20px;">üèÜ</div>
                
                <h2 id="final-score">Score: 0</h2>
                <p>Accuracy: <span id="accuracy">0%</span></p>
                <p>Coins Earned: <span id="coins-earned">0</span></p>
                
                <div style="margin-top: 30px;">
                    <button class="gold-btn" onclick="goHome()">Main Menu</button>
                    <button class="gold-btn" onclick="restartQuiz()">Retake</button>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <span class="copyright-text">AMER ALSHARIF 2026</span>
    </footer>

    <script>
        /* --- GAME DATA & CONTENT --- */
        const rawQuestions = [
            { q: "What is the primary function of the Immune System?", a: ["Protecting against infections", "Digesting food", "Pumping blood", "Filtering waste"], c: 0, exp: "The Immune System protects against infections and foreign substances." },
            { q: "Which cells are collectively known as phagocytes?", a: ["Neutrophils and macrophages", "Basophils and eosinophils", "B cells and T cells", "Platelets"], c: 0, exp: "Neutrophils and macrophages engulf and destroy pathogens." },
            { q: "What is the role of Basophils and Eosinophils?", a: ["Release histamine", "Phagocytosis", "Produce antibodies", "Clotting blood"], c: 0, exp: "They release signaling and inflammatory molecules like histamine." },
            { q: "Which T cells coordinate immune responses?", a: ["Helper T cells (CD4+)", "Cytotoxic T cells (CD8+)", "Suppressor T cells", "Memory T cells"], c: 0, exp: "Helper T cells release cytokines to activate B cells and macrophages." },
            { q: "What do Cytotoxic T cells (CD8+) do?", a: ["Destroy virus-infected cells", "Produce antibodies", "Release histamine", "Phagocytose bacteria"], c: 0, exp: "They recognize and destroy virus-infected or cancerous cells." },
            { q: "Which antibody is the most abundant in blood?", a: ["IgG", "IgA", "IgM", "IgE"], c: 0, exp: "IgG makes up ~75% of total antibodies." },
            { q: "Which antibody is the 'First Responder'?", a: ["IgM", "IgG", "IgA", "IgD"], c: 0, exp: "IgM is the first antibody produced during an initial immune response." },
            { q: "Which antibody is associated with mucosal protection?", a: ["IgA", "IgG", "IgM", "IgE"], c: 0, exp: "IgA protects mucosal surfaces (respiratory, digestive, urogenital)." },
            { q: "Which antibody triggers allergic reactions?", a: ["IgE", "IgG", "IgM", "IgD"], c: 0, exp: "IgE binds to mast cells and triggers histamine release." },
            { q: "In the GAMED acronym, what does 'E' stand for?", a: ["Emergency (Allergy)", "Erythrocyte", "Enzyme", "External"], c: 0, exp: "E = Emergency (Allergy, parasites)." },
            { q: "What is Passive Natural Immunity?", a: ["Antibodies from mother to fetus", "Vaccination", "Infection recovery", "Injection of serum"], c: 0, exp: "Antibodies pass from mother to fetus via placenta or milk." },
            { q: "What virus causes AIDS?", a: ["HIV", "HBV", "HCV", "Influenza"], c: 0, exp: "HIV leads to acquired immunodeficiency syndrome." },
            { q: "Which cells does HIV primarily infect?", a: ["CD4+ T cells", "Red blood cells", "Platelets", "Neutrophils"], c: 0, exp: "HIV infects CD4+ T cells, macrophages, and dendritic cells." },
            { q: "What is the main function of blood?", a: ["Transport O2 and CO2", "Store calcium", "Produce hormones", "Digest proteins"], c: 0, exp: "Blood carries O2 from lungs to tissues and CO2 back." },
            { q: "What percentage of blood is plasma?", a: ["55%", "45%", "10%", "90%"], c: 0, exp: "Blood is 55% plasma and 45% formed elements." },
            { q: "Which WBCs are Granulocytes?", a: ["Neutrophils, Eosinophils, Basophils", "Monocytes, Lymphocytes", "Erythrocytes, Platelets", "B cells, T cells"], c: 0, exp: "Granulocytes contain cytoplasmic granules." },
            { q: "Which WBC count increases in bacterial infections?", a: ["Neutrophils", "Lymphocytes", "Basophils", "Monocytes"], c: 0, exp: "Neutrophilia is associated with bacterial infections." },
            { q: "What is the normal platelet count?", a: ["150,000‚Äì400,000/mm¬≥", "50,000‚Äì100,000/mm¬≥", "500,000‚Äì600,000/mm¬≥", "10,000‚Äì50,000/mm¬≥"], c: 0, exp: "Normal count is 150,000‚Äì400,000 per mm¬≥." },
            { q: "Which anticoagulant is found in lavender top tubes?", a: ["EDTA", "Heparin", "Citrate", "Clot activator"], c: 0, exp: "Whole blood is collected in EDTA (lavender top) tubes." },
            { q: "What is ABO BLOOD GROUPS based on?", a: ["Antigens on RBCs", "White blood cell count", "Platelet shape", "Plasma proteins"], c: 0, exp: "Groups A, B, AB, O are based on RBC antigens." },
            { q: "Which antigen is most important in the Rhesus system?", a: ["D antigen", "C antigen", "E antigen", "e antigen"], c: 0, exp: "The D antigen is most important as it triggers strong immune response." },
            { q: "What happens if an Rh-negative mother has an Rh-positive baby?", a: ["Erythroblastosis Fetalis", "ABO incompatibility", "Leukemia", "Thrombocytosis"], c: 0, exp: "Mother's anti-D antibodies attack baby's RBCs (Hemolytic Disease)." },
            { q: "What is the Bombay Blood Group (Oh)?", a: ["Lacks H antigen", "Lacks A antigen", "Lacks B antigen", "Lacks D antigen"], c: 0, exp: "Bombay phenotype individuals lack the H antigen." },
            { q: "Who discovered the Bombay Blood Group?", a: ["Dr. Y. M. Bhende", "Landsteiner", "Louis Pasteur", "Robert Koch"], c: 0, exp: "Discovered by Dr. Y. M. Bhende in Bombay, India." },
            { q: "What is CPDA-1?", a: ["Anticoagulant", "Antibiotic", "Virus", "Blood type"], c: 0, exp: "Citrate Phosphate Dextrose with Adenine, an anticoagulant preservative." },
            { q: "How many chromosomes do humans have?", a: ["46", "23", "44", "48"], c: 0, exp: "Humans have 46 chromosomes (23 pairs)." },
            { q: "What is a Genotype?", a: ["Genetic makeup", "Observable traits", "Blood type", "Physical appearance"], c: 0, exp: "Genotype is the actual genetic makeup or DNA sequence." },
            { q: "Inheritance pattern of BRCA1/2 mutations?", a: ["Autosomal Dominant", "Autosomal Recessive", "X-Linked", "Mitochondrial"], c: 0, exp: "Only one mutated copy is needed for expression." },
            { q: "What is a Nonsense Mutation?", a: ["Creates a stop codon", "Changes one amino acid", "No change", "Deletes a gene"], c: 0, exp: "Creates a premature stop codon, shortening the protein." },
            { q: "Why is Informed Consent important?", a: ["Ethically and psychologically", "Legal only", "Cost saving", "Doctor's preference"], c: 0, exp: "It is crucial ethically and psychologically for patient autonomy." },
            { q: "What is the Chain of Infection?", a: ["Sequence of transmission", "DNA sequence", "Antibody chain", "Heart rhythm"], c: 0, exp: "6 elements required for infection transmission." },
            { q: "What is the most effective infection control measure?", a: ["Hand Hygiene", "Masks only", "Gowns only", "Gloves only"], c: 0, exp: "Hand hygiene is the single most important measure." },
            { q: "What biosafety level are most hospital labs?", a: ["BSL-2", "BSL-1", "BSL-3", "BSL-4"], c: 0, exp: "BSL-2 covers moderate-risk pathogens like Hepatitis." },
            { q: "What does PPE protect?", a: ["Healthcare worker", "Furniture only", "Air only", "Water supply"], c: 0, exp: "Creates a barrier between the worker and infectious agents." },
            { q: "What is the purpose of Safety-Engineered Devices?", a: ["Prevent needle sticks", "Cost reduction", "Faster collection", "Better storage"], c: 0, exp: "Needles with retractable mechanisms reduce injury rates." },
            { q: "What is the first step after a needlestick?", a: ["Wash wound", "Report next day", "Wait for symptoms", "Apply bandage only"], c: 0, exp: "Wash with soap and running water immediately." },
            { q: "What must NOT be used as a patient identifier?", a: ["Room number", "Name", "DOB", "MRN"], c: 0, exp: "Room numbers are not unique identifiers." },
            { q: "What specimen type is used for ABG analysis?", a: ["Arterial Blood", "Venous Blood", "Capillary Blood", "Urine"], c: 0, exp: "Arterial blood is used for blood gas analysis." },
            { q: "What is a 'Clean-Catch' urine specimen?", a: ["Midstream", "First morning", "24-hour", "Random"], c: 0, exp: "Discarding first and last portions reduces contamination." },
            { q: "Where is Cerebrospinal Fluid (CSF) collected?", a: ["Lumbar puncture", "Arm vein", "Finger stick", "Throat swab"], c: 0, exp: "Collected via lumbar puncture to diagnose meningitis etc." },
            { q: "What is Point-of-Care Testing (POCT)?", a: ["Bedside diagnostics", "Lab research", "Home cooking", "Radiology"], c: 0, exp: "Testing performed at or near the patient site." },
            { q: "Where does capillary blood come from?", a: ["Skin puncture", "Vein", "Artery", "Bone marrow"], c: 0, exp: "Obtained by pricking the fingertip or heel." },
            { q: "What is the 'Scan Line' feature?", a: ["Visual effect", "A lab tool", "A disease", "A blood cell"], c: 0, exp: "A visual effect to scan the whole page." },
            { q: "Which sound effect is included?", a: ["Alien", "Dog bark", "Car horn", "Music"], c: 0, exp: "Synthesized alien sound FX are included." },
            { q: "What happens when you answer correctly?", a: ["Hearts appear", "Alien disappears", "Screen turns blue", "Game ends"], c: 0, exp: "Bubbles and hearts appear for correct answers." },
            { q: "The Immune System is a complex system responsible for?", a: ["Protecting us", "Digestion", "Movement", "Sensation"], c: 0, exp: "Protecting us against infections and foreign substances." },
            { q: "Basophils release what molecule?", a: ["Histamine", "Insulin", "Adrenaline", "Estrogen"], c: 0, exp: "Basophils release signaling and inflammatory molecules like histamine." }
        ];

        let baseQuestionBank = [];
        
        function generateVariations() {
            const vars = [];
            rawQuestions.forEach(q => {
                vars.push(q);
                if (Math.random() > 0.5) {
                    vars.push({
                        q: `True or False: ${q.exp}`,
                        a: ["True", "False"],
                        c: 0,
                        exp: q.exp
                    });
                }
            });
            return vars;
        }
        baseQuestionBank = generateVariations();
        
        /* --- STATE MANAGEMENT --- */
        let currentMode = 'study';
        let currentQuestionIndex = 0;
        let score = 0;
        let coins = parseInt(localStorage.getItem('goldExamCoins')) || 0;
        let questions = [];
        let userAnswers = [];
        let timerInterval;
        let timeRemaining = 0;

        /* --- AUDIO SYSTEM --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playAlienSound(type = 'hover') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'correct') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.5);
            } else if (type === 'wrong') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'click') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.1);
            } else if (type === 'scan') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(2000, audioCtx.currentTime + 1.5);
                gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 1.5);
                osc.start();
                osc.stop(audioCtx.currentTime + 1.5);
            }
        }

        /* --- UI UPDATES --- */
        document.getElementById('coin-display').innerText = coins;
        document.getElementById('score-display').innerText = score;

        /* --- DRAGGABLE ALIEN --- */
        const pet = document.getElementById('alien-pet');
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        pet.addEventListener('mousedown', (e) => {
            isDragging = true;
            playAlienSound('click');
            startX = e.clientX;
            startY = e.clientY;
            initialLeft = pet.offsetLeft;
            initialTop = pet.offsetTop;
            pet.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            pet.style.left = `${initialLeft + dx}px`;
            pet.style.top = `${initialTop + dy}px`;
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            pet.style.cursor = 'grab';
        });

        /* --- SCANNER TOGGLE --- */
        document.getElementById('scan-toggle').addEventListener('change', (e) => {
            if (e.target.checked) {
                document.body.classList.add('scanning');
                playAlienSound('scan');
            } else {
                document.body.classList.remove('scanning');
            }
        });

        /* --- GAME LOGIC --- */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startQuiz(mode) {
            playAlienSound('click');
            currentMode = mode;
            currentQuestionIndex = 0;
            score = 0;
            
            // Get user requested count
            let desiredCount = parseInt(document.getElementById('q-count').value) || 50;
            // Cap at 200
            desiredCount = Math.min(Math.max(desiredCount, 1), 200);
            
            // Build question array to match desired count
            // Loop the bank if user wants more questions than generated variations
            let tempPool = shuffleArray([...baseQuestionBank]);
            questions = [];
            
            while(questions.length < desiredCount) {
                questions = questions.concat(tempPool);
            }
            questions = questions.slice(0, desiredCount);

            userAnswers = new Array(questions.length).fill(null);
            
            // Shuffle options within each question
            questions.forEach(q => {
                const originalCorrectText = q.a[q.c];
                q.a = shuffleArray([...q.a]);
                q.c = q.a.indexOf(originalCorrectText);
            });

            document.getElementById('start-screen').classList.remove('active');
            document.getElementById('quiz-screen').classList.add('active');
            
            document.getElementById('q-total').innerText = questions.length;
            renderNavigator();
            loadQuestion(0);

            if (mode === 'exam') {
                startTimer();
                document.getElementById('timer-display').style.display = 'block';
            } else {
                document.getElementById('timer-display').style.display = 'none';
            }
        }

        function startTimer() {
            // 30 seconds per question
            timeRemaining = questions.length * 30; 
            timerInterval = setInterval(() => {
                timeRemaining--;
                const m = Math.floor(timeRemaining / 60);
                const s = timeRemaining % 60;
                document.getElementById('timer-display').innerText = 
                    `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    finishQuiz();
                }
            }, 1000);
        }

        function loadQuestion(index) {
            currentQuestionIndex = index;
            const q = questions[index];
            
            document.getElementById('q-current').innerText = index + 1;
            document.getElementById('question-text').innerText = q.q;
            
            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = '';
            
            document.getElementById('feedback-box').style.display = 'none';
            const nextBtn = document.getElementById('next-btn');
            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.5';

            q.a.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = opt;
                btn.onclick = () => selectAnswer(i, btn, q.c, q.exp);
                optionsDiv.appendChild(btn);
            });

            updateNavigator();
        }

        function selectAnswer(selectedIndex, btnElement, correctIndex, explanation) {
            const options = document.querySelectorAll('.option-btn');
            options.forEach(o => o.style.pointerEvents = 'none');

            const isCorrect = selectedIndex === correctIndex;
            userAnswers[currentQuestionIndex] = isCorrect;

            if (isCorrect) {
                btnElement.classList.add('correct');
                playAlienSound('correct');
                score += 10;
                coins += 1;
                spawnParticles(btnElement);
                spawnEmojis(btnElement);
            } else {
                btnElement.classList.add('wrong');
                options[correctIndex].classList.add('correct');
                playAlienSound('wrong');
            }

            document.getElementById('score-display').innerText = score;
            localStorage.setItem('goldExamCoins', coins);
            document.getElementById('coin-display').innerText = coins;

            const fb = document.getElementById('feedback-box');
            fb.innerHTML = isCorrect 
                ? `<span style="color:#2ecc71">Correct! </span> ${explanation}`
                : `<span style="color:#e74c3c">Incorrect. </span> ${explanation}`;
            fb.style.display = 'block';

            updateNavigator();

            const nextBtn = document.getElementById('next-btn');
            nextBtn.disabled = false;
            nextBtn.style.opacity = '1';
        }

        function nextQuestion() {
            playAlienSound('click');
            if (currentQuestionIndex < questions.length - 1) {
                loadQuestion(currentQuestionIndex + 1);
            } else {
                finishQuiz();
            }
        }

        function updateNavigator() {
            const nav = document.getElementById('nav-dots');
            nav.innerHTML = '';
            // If there are too many questions, dots might get cluttered, but we allow scrolling
            questions.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = 'nav-dot';
                dot.innerText = i + 1;
                if (i === currentQuestionIndex) dot.classList.add('active');
                
                if (userAnswers[i] === true) dot.classList.add('correct');
                else if (userAnswers[i] === false) dot.classList.add('wrong');
                else if (userAnswers[i] === null) dot.classList.add('pending');

                dot.onclick = () => {
                     // Allow jumping back in study mode, or if answered
                     if (currentMode === 'study' || userAnswers[i] !== null) {
                         playAlienSound('click');
                         loadQuestion(i);
                     }
                };
                nav.appendChild(dot);
            });
        }

        function renderNavigator() {
            // Placeholder
        }

        /* --- PARTICLE & EMOJI SYSTEMS --- */
        function spawnParticles(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < 15; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.innerText = ['‚ù§Ô∏è', 'üíõ', 'üíñ', 'üß°', 'üíõ'][Math.floor(Math.random() * 5)];
                p.style.left = centerX + (Math.random() - 0.5) * 50 + 'px';
                p.style.top = centerY + 'px';
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1500);
            }
        }

        function spawnEmojis(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const emojis = ['üëæ', 'üöÄ', '‚ú®', 'üåü', 'üß¨', 'ü©∏'];
            for (let i = 0; i < 5; i++) {
                const e = document.createElement('div');
                e.className = 'emoji-effect';
                e.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                e.style.left = centerX + (Math.random() - 0.5) * 100 + 'px';
                e.style.top = centerY + 'px';
                document.body.appendChild(e);
                setTimeout(() => e.remove(), 1000);
            }
        }

        /* --- FINISH QUIZ --- */
        function finishQuiz() {
            clearInterval(timerInterval);
            playAlienSound('correct');
            
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');

            const total = questions.length;
            const correctCount = userAnswers.filter(a => a === true).length;
            const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;

            document.getElementById('final-score').innerText = `Score: ${score}`;
            document.getElementById('accuracy').innerText = `Accuracy: ${accuracy}%`;
            document.getElementById('coins-earned').innerText = `+${correctCount} Coins`;
        }

        function goHome() {
            playAlienSound('click');
            document.getElementById('result-screen').classList.remove('active');
            document.getElementById('start-screen').classList.add('active');
        }

        function restartQuiz() {
            playAlienSound('click');
            startQuiz(currentMode);
        }
    </script>
</body>
</html>