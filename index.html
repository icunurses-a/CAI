<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratory Final Exam</title>
    <style>
        /* --- CORE VARIABLES & RESET --- */
        :root {
            --gold-base: #D4AF37;
            --gold-light: #F9E59E;
            --gold-dark: #AA8A2E;
            --bg-dark: #0f0f0f;
            --bg-panel: #1a1a1a;
            --text-main: #ffffff;
            --accent-red: #ff4d4d;
            --accent-green: #4dff4d;
            --font-display: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-drag: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-display);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- GOLD & RGB EFFECTS --- */
        .gold-text {
            background: linear-gradient(135deg, var(--gold-light), var(--gold-base), var(--gold-dark));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: bold;
            text-shadow: 0px 2px 10px rgba(212, 175, 55, 0.3);
        }

        .shaky-dancy {
            display: inline-block;
            animation: shaky-dancy 0.5s infinite alternate;
        }

        .rgb-text {
            font-weight: 900;
            font-size: 1.2em;
            background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff, #ff0000);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: rgb-flow 3s linear infinite;
        }

        .wavy-rgb {
            display: inline-block;
            font-family: 'Courier New', monospace;
            animation: wavy-anim 2s ease-in-out infinite;
        }

        @keyframes shaky-dancy {
            0% { transform: skewX(-10deg) rotate(-2deg); filter: hue-rotate(0deg); }
            25% { transform: skewX(10deg) rotate(2deg); filter: hue-rotate(90deg); }
            50% { transform: skewX(-5deg) scale(1.1); filter: hue-rotate(180deg); }
            75% { transform: skewX(5deg) scale(1.1); filter: hue-rotate(270deg); }
            100% { transform: skewX(0deg) rotate(0deg); filter: hue-rotate(360deg); }
        }

        @keyframes rgb-flow {
            0% { background-position: 0% 50%; }
            100% { background-position: 100% 50%; }
        }

        @keyframes wavy-anim {
            0%, 100% { transform: translateY(0) scale(1); letter-spacing: 2px; }
            50% { transform: translateY(-5px) scale(1.1); letter-spacing: 4px; text-shadow: 2px 2px #ff00ff; }
        }

        /* --- SCAN LINE --- */
        #scan-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(212, 175, 55, 0.8);
            box-shadow: 0 0 15px var(--gold-base);
            z-index: 9999;
            pointer-events: none;
            animation: scan-down 4s linear infinite;
        }

        @keyframes scan-down {
            0% { top: -5%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 105%; opacity: 0; }
        }

        /* --- LAYOUT --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            position: relative;
            z-index: 10;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gold-dark);
            padding-bottom: 20px;
        }

        h1 {
            font-size: 2.5rem;
            margin: 0;
        }

        footer {
            text-align: center;
            padding: 20px;
            font-size: 0.9rem;
            background: #000;
            border-top: 1px solid var(--gold-dark);
        }

        /* --- SCREENS --- */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- START SCREEN --- */
        .card {
            background: linear-gradient(145deg, #222, #151515);
            border: 1px solid var(--gold-dark);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }

        .setting-group {
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: var(--gold-light);
            font-size: 1.1rem;
        }

        input[type="range"], select, input[type="number"] {
            background: #000;
            color: var(--gold-base);
            border: 1px solid var(--gold-dark);
            padding: 10px;
            border-radius: 5px;
            font-size: 1rem;
            width: 100%;
            max-width: 300px;
            text-align: center;
        }

        button {
            background: linear-gradient(to right, var(--gold-dark), var(--gold-base));
            border: none;
            padding: 15px 30px;
            color: #000;
            font-weight: bold;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.4);
            margin: 10px;
        }

        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.6);
        }

        button:active {
            transform: scale(0.95);
        }

        /* --- QUIZ UI --- */
        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.6);
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--gold-dark);
        }

        .hud-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
        }

        .question-box {
            font-size: 1.3rem;
            margin-bottom: 30px;
            line-height: 1.5;
            min-height: 80px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .option-btn {
            background: #2a2a2a;
            color: white;
            border: 2px solid var(--gold-dark);
            padding: 20px;
            border-radius: 10px;
            text-align: left;
            font-size: 1rem;
            transition: 0.3s;
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover {
            background: #333;
            border-color: var(--gold-light);
        }

        .option-btn.correct {
            background: rgba(0, 100, 0, 0.8) !important;
            border-color: var(--accent-green);
        }

        .option-btn.wrong {
            background: rgba(100, 0, 0, 0.8) !important;
            border-color: var(--accent-red);
        }

        /* --- FEEDBACK & ANIMATIONS --- */
        .bubble {
            position: absolute;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            font-size: 2rem;
            z-index: 100;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* --- NAVIGATOR --- */
        .navigator {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 20px;
            justify-content: center;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .nav-dot {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            background: #333;
            border: 1px solid #555;
            color: #aaa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .nav-dot.active { background: var(--gold-base); color: black; border-color: #fff; }
        .nav-dot.answered { background: var(--gold-dark); border-color: var(--gold-light); }
        .nav-dot.correct { background: var(--accent-green); }
        .nav-dot.wrong { background: var(--accent-red); }

        /* --- ALIEN PET --- */
        #alien-pet {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            cursor: grab;
            z-index: 10000;
            filter: drop-shadow(0 0 10px var(--gold-base));
            transition: transform 0.1s;
        }
        
        #alien-pet:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid var(--gold-base);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.3);
        }

        .score-display {
            font-size: 4rem;
            color: var(--gold-base);
            margin: 20px 0;
            font-weight: bold;
        }

        /* Responsive */
        @media (min-width: 600px) {
            .options-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <!-- VISUAL EFFECTS -->
    <div id="scan-line"></div>
    <div id="particles-container"></div>

    <!-- MOVABLE ALIEN PET -->
    <div id="alien-pet">
        <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="50" cy="50" r="45" fill="#76c7c0" stroke="#D4AF37" stroke-width="3"/>
            <ellipse cx="35" cy="40" rx="8" ry="12" fill="black"/>
            <ellipse cx="65" cy="40" rx="8" ry="12" fill="black"/>
            <path d="M35 65 Q50 80 65 65" stroke="black" stroke-width="3" stroke-linecap="round"/>
            <circle cx="20" cy="50" r="10" fill="#76c7c0" stroke="#D4AF37" stroke-width="2"/>
            <circle cx="80" cy="50" r="10" fill="#76c7c0" stroke="#D4AF37" stroke-width="2"/>
        </svg>
    </div>

    <div class="container">
        <header>
            <h1 class="gold-text">LABORATORY <span class="shaky-dancy rgb-text">FINAL</span></h1>
            <p>Immune System ‚Ä¢ Blood ‚Ä¢ Genetics ‚Ä¢ Biosafety</p>
        </header>

        <!-- START SCREEN -->
        <div id="start-screen" class="screen active">
            <div class="card">
                <div class="setting-group">
                    <label>Game Mode</label>
                    <select id="game-mode">
                        <option value="exam">Exam Mode (Strict Timing)</option>
                        <option value="study">Study/Review (Instant Feedback)</option>
                    </select>
                </div>

                <div class="setting-group">
                    <label>Number of Questions (Max 200)</label>
                    <input type="number" id="question-count" value="50" min="5" max="200">
                </div>

                <div class="setting-group">
                    <label style="font-size: 0.9rem; opacity: 0.8;">
                        <input type="checkbox" id="shuffle-opt" checked> Shuffle Questions & Answers
                    </label>
                </div>

                <button onclick="startGame()">Start Challenge</button>
            </div>
            
            <div class="card">
                <h3 class="gold-text">Your Collection</h3>
                <div id="collection-display" style="display: flex; gap: 10px; justify-content: center; font-size: 2rem;">
                    <!-- Unlocked items appear here -->
                    <span title="Novice">ü•ö</span>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="hud">
                <div class="hud-item">
                    <span>‚è±Ô∏è</span> <span id="timer">00:00</span>
                </div>
                <div class="hud-item">
                    <span>‚ù§Ô∏è</span> <span id="lives">3</span>
                </div>
                <div class="hud-item">
                    <span>üí∞</span> <span id="score">0</span>
                </div>
                <div class="hud-item">
                    <span>üèÜ</span> <span id="progress">1/50</span>
                </div>
            </div>

            <div class="card">
                <div id="question-text" class="question-box">Loading...</div>
                <div id="options-container" class="options-grid">
                    <!-- Options injected here -->
                </div>
                <div id="feedback-area" style="text-align: center; margin-top: 15px; height: 20px; font-weight: bold;"></div>
            </div>

            <div class="navigator" id="nav-container">
                <!-- Dots injected here -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button onclick="endGame()" style="background: #8b0000; border-color: red; color: white;">End Test</button>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="result-screen" class="screen">
            <div class="card" style="text-align: center;">
                <h2 class="gold-text">Mission Complete</h2>
                <div class="score-display" id="final-score">0</div>
                <p>Total Coins Earned: <span id="final-coins" class="gold-text">0</span></p>
                <p>Accuracy: <span id="accuracy">0%</span></p>
                
                <div id="new-unlocks" style="margin: 20px 0; display: none;">
                    <h3 class="gold-text">New Unlocks!</h3>
                    <div id="unlock-icons" style="font-size: 3rem;"></div>
                </div>

                <button onclick="goToStart()">Play Again</button>
            </div>
        </div>
    </div>

    <footer>
        <span class="wavy-rgb">AMER ALSHARIF 2026</span>
    </footer>

    <!-- CUSTOM MODAL -->
    <div id="custom-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title" class="gold-text">Alert</h2>
            <p id="modal-message">Message</p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

    <script>
        /* 
         * DATA GENERATION ENGINE
         * Generates 200 questions based on the provided text content.
         */
        const rawTopics = [
            { t: "Immune System", q: ["What is the main function of the Immune System?", "Which system protects against infections?"], a: ["Protecting us against infections and foreign substances", "Producing red blood cells", "Digesting food", "Regulating body temperature"], c: 0 },
            { t: "Innate Immunity", q: ["What is the second line of defense called?", "Which cells release histamine to attract immune cells?"], a: ["Innate Immunity", "Adaptive Immunity", "Passive Immunity", "Specific Immunity"], c: 0 },
            { t: "WBCs", q: ["Which cells are collectively known as phagocytes?", "Basophils and eosinophils release which molecule?"], a: ["Neutrophils and macrophages", "B and T cells", "Platelets", "Erythrocytes"], c: 0 },
            { t: "Histamine", q: ["Which molecule is released by basophils and eosinophils?", "What attracts other immune cells to a site of infection?"], a: ["Histamine", "Insulin", "Adrenaline", "Melatonin"], c: 0 },
            { t: "T Cells", q: ["T lymphocytes are part of which immune system?", "Helper T cells (CD4+) coordinate responses by releasing what?"], a: ["Adaptive immune system", "Innate immune system", "Circulatory system", "Skeletal system"], c: 0 },
            { t: "Cytokines", q: ["What do Helper T cells release to activate B cells?", "What do Cytotoxic T cells (CD8+) destroy?"], a: ["Cytokines", "Antibodies", "Histamine", "Enzymes"], c: 0 },
            { t: "Cytotoxic T Cells", q: ["Which cells recognize and destroy virus-infected or cancerous cells?", "What is the function of CD8+ T cells?"], a: ["Cytotoxic T cells (CD8+)", "Helper T cells (CD4+)", "B cells", "Neutrophils"], c: 0 },
            { t: "Antibodies", q: ["How many main classes of antibodies (immunoglobulins) are there?", "What are antibodies also known as?"], a: ["Five (IgG, IgA, IgM, IgE, IgD)", "Three", "Two", "Ten"], c: 0 },
            { t: "IgG", q: ["Which antibody is the most abundant in blood (~75%)?", "Which antibody provides long-term immunity?"], a: ["IgG", "IgA", "IgM", "IgE"], c: 0 },
            { t: "Placenta", q: ["Which antibody can cross the placenta to protect the fetus?", "IgG provides which type of immunity to the fetus?"], a: ["IgG", "IgA", "IgM", "IgD"], c: 0 },
            { t: "IgA", q: ["Where is IgA primarily found?", "Which antibody protects mucosal surfaces?"], a: ["Mucus, saliva, tears, breast milk", "Blood only", "Bone marrow", "Urine"], c: 0 },
            { t: "IgM", q: ["Which antibody is the first responder in an infection?", "Which antibody is excellent at agglutination?"], a: ["IgM", "IgG", "IgA", "IgE"], c: 0 },
            { t: "IgE", q: ["Which antibody is involved in allergic reactions?", "Which antibody binds to mast cells?"], a: ["IgE", "IgG", "IgM", "IgD"], c: 0 },
            { t: "Parasites", q: ["IgE provides defence against what?", "Which antibody defends against helminths?"], a: ["Parasitic worms (helminths)", "Bacteria", "Viruses", "Fungi"], c: 0 },
            { t: "IgD", q: ["Which antibody functions mainly as a B-cell receptor?", "Where is IgD mainly found?"], a: ["IgD", "IgG", "IgM", "IgE"], c: 0 },
            { t: "GAMED", q: ["In the acronym GAMED, what does 'A' stand for?", "In GAMED, what does 'E' stand for?"], a: ["At mucosal surfaces", "Acute immunity", "Always active", "Antibody generation"], c: 0 },
            { t: "Adaptive Immunity", q: ["What are the two types of Adaptive Immunity?", "Active and Passive are types of which immunity?"], a: ["Active and Passive", "Innate and Acquired", "Natural and Artificial", "Specific and Non-specific"], c: 0 },
            { t: "Natural Active", q: ["Naturally acquired Active immunity occurs when?", "How are antibodies naturally acquired passively?"], a: ["Antigens enter the body naturally", "Vaccination", "Injection of serum", "Through touch"], c: 0 },
            { t: "Natural Passive", q: ["How do antibodies pass from mother to infant naturally?", "What is an example of naturally acquired passive immunity?"], a: ["Via placenta or mother's milk", "Through vaccination", "Via blood transfusion", "Through inhalation"], c: 0 },
            { t: "Artificial Active", q: ["What is Artificially acquired Active immunity?", "How are antigens introduced in artificial active immunity?"], a: ["Vaccination", "Infection", "Mother's milk", "Serum injection"], c: 0 },
            { t: "HIV", q: ["What virus causes AIDS?", "Which immune cells does HIV primarily infect?"], a: ["Human Immunodeficiency Virus", "Influenza virus", "Hepatitis B", "Epstein-Barr"], c: 0 },
            { t: "CD4", q: ["HIV primarily infects which cells?", "What happens to CD4+ T cell counts in HIV?"], a: ["CD4‚Å∫ T cells", "Red blood cells", "Platelets", "Neutrophils"], c: 0 },
            { t: "ART", q: ["What therapy suppresses HIV viral replication?", "What does ART stand for?"], a: ["Antiretroviral therapy", "Antibiotic Resistance Therapy", "Advanced Radiotherapy", "Acute Rehab Treatment"], c: 0 },
            { t: "Blood Function", q: ["What is the primary transport function of blood?", "Blood helps maintain which balance?"], a: ["Carries O2 and CO2", "Stores calcium", "Produces hormones", "Digests proteins"], c: 0 },
            { t: "Blood Composition", q: ["Blood is approximately how much plasma?", "What are the formed elements of blood?"], a: ["55%", "90%", "10%", "75%"], c: 0 },
            { t: "RBC", q: ["What is the shape of Red Blood Cells?", "What is another name for RBCs?"], a: ["Biconcave", "Spherical", "Cuboidal", "Irregular"], c: 0 },
            { t: "Neutrophils", q: ["Which WBC is the most abundant (45-75%)?", "Neutrophils increase in which condition?"], a: ["Neutrophils", "Lymphocytes", "Eosinophils", "Basophils"], c: 0 },
            { t: "Bacterial Infection", q: ["Neutrophils perform phagocytosis of what?", "An increase in neutrophils is called what?"], a: ["Bacteria", "Viruses", "Parasites", "Fungi"], c: 0 },
            { t: "Eosinophils", q: ["Which WBC responds to parasitic infections?", "Eosinophils increase in allergic reactions and?"], a: ["Eosinophils", "Basophils", "Monocytes", "Neutrophils"], c: 0 },
            { t: "Basophils", q: ["Which WBC releases histamine and heparin?", "Basophils are involved in what response?"], a: ["Basophils", "Neutrophils", "Lymphocytes", "Monocytes"], c: 0 },
            { t: "Monocytes", q: ["Monocytes become what in tissues?", "Which WBC becomes a macrophage?"], a: ["Macrophages", "Neutrophils", "Plasma cells", "Mast cells"], c: 0 },
            { t: "Lymphocytes", q: ["Which cells provide cellular immunity?", "B cells produce what?"], a: ["T cells", "Neutrophils", "Platelets", "Erythrocytes"], c: 0 },
            { t: "Platelets", q: ["What is the normal count of platelets?", "Where are platelets derived from?"], a: ["150,000‚Äì400,000/mm¬≥", "1-5 million", "5000-10000", "1 million"], c: 0 },
            { t: "Megakaryocytes", q: ["Platelets are fragments of which cells?", "What is the lifespan of platelets?"], a: ["Megakaryocytes", "Lymphocytes", "Erythrocytes", "Monocytes"], c: 0 },
            { t: "Thrombocytopenia", q: ["What is a low platelet count called?", "Thrombocytopenia leads to what risk?"], a: ["Excessive bleeding", "Clotting", "High BP", "Anemia"], c: 0 },
            { t: "EDTA", q: ["Whole blood is collected in which colored tube for CBC?", "What anticoagulant is in lavender top tubes?"], a: ["EDTA (Lavender)", "Heparin (Green)", "Clot (Red)", "Sodium Citrate (Blue)"], c: 0 },
            { t: "Blood Transfusion", q: ["Who discovered the ABO blood groups?", "What made blood transfusion safe?"], a: ["Landsteiner", "Pasteur", "Fleming", "Jenner"], c: 0 },
            { t: "ABO", q: ["What are the main ABO blood groups?", "Which blood group has no antigens?"], a: ["A, B, AB, O", "A, B, O", "A+, B+, O+", "Rh positive only"], c: 0 },
            { t: "Rh Factor", q: ["What is the most important antigen in the Rh system?", "People who are Rh negative lack which antigen?"], a: ["D antigen", "C antigen", "E antigen", "A antigen"], c: 0 },
            { t: "Erythroblastosis Fetalis", q: ["What is another name for Hemolytic Disease of the Newborn?", "When does Erythroblastosis Fetalis occur?"], a: ["When mother is Rh negative, baby is Rh positive", "When mother is Rh positive", "Always", "Never"], c: 0 },
            { t: "Bombay Blood", q: ["What antigen is missing in the Bombay blood group?", "What is the frequency of Bombay blood group?"], a: ["H antigen", "A antigen", "B antigen", "D antigen"], c: 0 },
            { t: "Anticoagulants", q: ["What was the first anticoagulant preservative discovered in 1916?", "What does CPDA-1 stand for?"], a: ["Citrate-Glucose", "Heparin", "Warfarin", "EDTA"], c: 0 },
            { t: "DNA", q: ["What is the molecular structure of DNA?", "DNA contains how many nucleotide bases?"], a: ["Double helix", "Triple helix", "Single strand", "Quad helix"], c: 0 },
            { t: "Genotype", q: ["What is the actual genetic makeup of an individual?", "What are observable characteristics called?"], a: ["Genotype", "Phenotype", "Allele", "Trait"], c: 0 },
            { t: "Autosomal Dominant", q: ["How many mutated copies are needed for Autosomal Dominant disease?", "What is the transmission risk for Autosomal Dominant?"], a: ["One", "Two", "Three", "Zero"], c: 0 },
            { t: "Autosomal Recessive", q: ["Cystic fibrosis follows which inheritance pattern?", "How many mutated copies are needed for Autosomal Recessive?"], a: ["Autosomal Recessive", "X-linked", "Dominant", "Mitochondrial"], c: 0 },
            { t: "X-Linked", q: ["Hemophilia is an example of which inheritance?", "Who is primarily affected by X-linked disorders?"], a: ["Males", "Females", "Both equally", "Elderly"], c: 0 },
            { t: "BRCA", q: ["BRCA1/2 mutations are associated with which cancer?", "What is the inheritance risk for BRCA mutations?"], a: ["Breast/Ovarian", "Lung", "Skin", "Prostate"], c: 0 },
            { t: "Informed Consent", q: ["Why is informed consent important genetically?", "What must be discussed before genetic testing?"], a: ["Ethically and psychologically", "Only costs", "Only time", "Nothing"], c: 0 },
            { t: "Infection Control", q: ["What is the goal of Infection Control?", "What prevents transmission of infectious agents?"], a: ["Prevent transmission", "Kill all bacteria", "Clean floors", "Wash walls"], c: 0 },
            { t: "Chain of Infection", q: ["How many elements are in the Chain of Infection?", "Breaking any link in the chain does what?"], a: ["Six", "Ten", "Two", "One"], c: 0 },
            { t: "Reservoir", q: ["Where does the pathogen live and multiply?", "What is the portal of exit?"], a: ["Reservoir", "Host", "Vector", "Vehicle"], c: 0 },
            { t: "Standard Precautions", q: ["What is the single most important measure to prevent infection?", "When should Standard Precautions be applied?"], a: ["Hand Hygiene", "Wearing a mask", "Gloves only", "Gown only"], c: 0 },
            { t: "PPE", q: ["What creates a barrier between you and infectious agents?", "What does PPE stand for?"], a: ["Personal Protective Equipment", "Patient Personal Equipment", "Private Protective Eye", "Public Protection Equipment"], c: 0 },
            { t: "Biosafety", q: ["What level do most hospital labs operate at?", "Which BSL involves agents like Hepatitis viruses?"], a: ["BSL-2", "BSL-1", "BSL-3", "BSL-4"], c: 0 },
            { t: "BSL-4", q: ["Which Biosafety Level handles dangerous agents like Ebola?", "What type of suits are used in BSL-4?"], a: ["Positive-pressure suits", "Surgical masks", "No protection needed", "Gloves only"], c: 0 },
            { t: "Eye Protection", q: ["What does eye protection protect?", "When are masks and eye protection required?"], a: ["Mucous membranes", "Hands", "Feet", "Hair"], c: 0 },
            { t: "Sharps Safety", q: ["What devices significantly reduce needlestick injuries?", "Where should sharps be disposed?"], a: ["Safety-Engineered Devices", "Trash can", "Pocket", "Floor"], c: 0 },
            { t: "Exposure Protocol", q: ["What is the first step after a needlestick injury?", "What should be done for mucous membrane exposure?"], a: ["Wash with soap/water", "Ignore it", "Bandage tightly", "Apply heat"], c: 0 },
            { t: "Patient ID", q: ["Which identifier must NOT be used to identify a patient?", "What are two acceptable patient identifiers?"], a: ["Room number", "Name and DOB", "Address and Phone", "MRN and Name"], c: 0 },
            { t: "Specimen Collection", q: ["What must be verified before collecting a specimen?", "What is the most common blood sample type?"], a: ["Patient Identity", "Doctor's mood", "Time of day", "Weather"], c: 0 },
            { t: "Urine Specimen", q: ["What is a 'clean-catch' urine specimen?", "What is a random urine specimen used for?"], a: ["Midstream specimen", "First morning only", "24 hour only", "Catheter only"], c: 0 },
            { t: "Sputum", q: ["What is a sample of mucus coughed up from lungs?", "What is a Nasopharyngeal swab used for?"], a: ["Sputum", "Urine", "Blood", "CSF"], c: 0 },
            { t: "POCT", q: ["What does POCT stand for?", "Where is Point-of-Care Testing performed?"], a: ["Point-of-Care Testing", "Pathology of Clinical Tech", "Point of Care Treatment", "Patient Online Check Tool"], c: 0 },
            { t: "Capillary Blood", q: ["Where does capillary blood come from?", "What is the advantage of capillary blood collection?"], a: ["Skin prick (Finger/Heel)", "Vein", "Artery", "Bone marrow"], c: 0 },
            { t: "Glucose", q: ["What is a common application of POCT?", "What test detects hCG in POCT?"], a: ["Blood Glucose Monitoring", "CBC", "Biopsy", "MRI"], c: 0 }
        ];

        // Function to generate 200 questions from the core topics
        function generateQuestions() {
            let allQuestions = [];
            let idCounter = 1;

            rawTopics.forEach((topic, index) => {
                // Create variations for each topic to reach 200 total
                // 1. Standard Question
                if (topic.q[0]) {
                    allQuestions.push({
                        id: idCounter++,
                        text: topic.q[0],
                        options: [...topic.a],
                        correctIndex: topic.c,
                        category: topic.t
                    });
                }
                
                // 2. Variation (if exists)
                if (topic.q[1]) {
                    allQuestions.push({
                        id: idCounter++,
                        text: topic.q[1],
                        options: [...topic.a],
                        correctIndex: topic.c,
                        category: topic.t
                    });
                }

                // 3. Negative variation (Which is NOT...) - Generating procedural questions to fill up
                // We create a "Not" version of the question
                const correctAnswer = topic.a[topic.c];
                const wrongOptions = topic.a.filter((_, i) => i !== topic.c);
                // Pick a wrong option to be the correct answer for the "Not" question
                const newCorrect = wrongOptions[0];
                
                allQuestions.push({
                    id: idCounter++,
                    text: `Which of the following is NOT a feature of ${topic.t}?`,
                    options: [correctAnswer, newCorrect, wrongOptions[1] || "Option C", "Option D"].sort(() => Math.random() - 0.5),
                    correctIndex: 0, // The original correct answer is the "wrong" feature
                    category: topic.t + " (Negative)"
                });
            });

            // Fill remaining to reach 200 by duplicating core questions with shuffled IDs
            while (allQuestions.length < 200) {
                const randomSource = rawTopics[Math.floor(Math.random() * rawTopics.length)];
                allQuestions.push({
                    id: idCounter++,
                    text: randomSource.q[0] || `Question about ${randomSource.t}`,
                    options: [...randomSource.a].sort(() => Math.random() - 0.5),
                    correctIndex: 0, // Reset logic needs to find the original answer text index
                    category: randomSource.t + " (Review)"
                });
                // Re-align correct index after shuffle for duplicated questions
                const originalAnswer = randomSource.a[randomSource.c];
                allQuestions[allQuestions.length - 1].correctIndex = allQuestions[allQuestions.length - 1].options.indexOf(originalAnswer);
            }

            return allQuestions.slice(0, 200); // Ensure exactly 200
        }

        const fullQuestionBank = generateQuestions();

        /* --- GAME ENGINE --- */
        const state = {
            questions: [],
            currentIndex: 0,
            score: 0,
            coins: 0,
            mode: 'exam',
            timer: 0,
            timerInterval: null,
            answers: [], // Stores { index: number, selected: index, correct: boolean }
            startTime: 0
        };

        // DOM Elements
        const screens = document.querySelectorAll('.screen');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const navContainer = document.getElementById('nav-container');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const livesDisplay = document.getElementById('lives'); // Currently mapped to lives or unused, using score
        const progressDisplay = document.getElementById('progress');
        const modal = document.getElementById('custom-modal');
        const alienPet = document.getElementById('alien-pet');

        // Sound Engine (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            const now = audioCtx.currentTime;
            
            if (type === 'correct') {
                // High pitched "alien" ding
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            } else if (type === 'wrong') {
                // Low pitched "bloop"
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'click') {
                // Short blip
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(300, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            }
        }

        // Functions
        function showScreen(id) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            const countInput = document.getElementById('question-count');
            let count = parseInt(countInput.value);
            if (count < 5) count = 5;
            if (count > 200) count = 200;

            state.mode = document.getElementById('game-mode').value;
            state.questions = shuffle([...fullQuestionBank]).slice(0, count);
            state.currentIndex = 0;
            state.score = 0;
            state.coins = 0;
            state.answers = new Array(count).fill(null);
            state.startTime = Date.now();

            if (document.getElementById('shuffle-opt').checked) {
                state.questions.forEach(q => {
                    // Save original answer text
                    const correctText = q.options[q.correctIndex];
                    // Shuffle options
                    q.options = shuffle(q.options);
                    // Find new index
                    q.correctIndex = q.options.indexOf(correctText);
                });
            }

            updateHUD();
            buildNavigator();
            renderQuestion();
            startTimer();
            showScreen('game-screen');
            playSound('click');
        }

        function startTimer() {
            clearInterval(state.timerInterval);
            state.timer = 0;
            state.timerInterval = setInterval(() => {
                state.timer++;
                const m = Math.floor(state.timer / 60).toString().padStart(2, '0');
                const s = (state.timer % 60).toString().padStart(2, '0');
                timerDisplay.textContent = `${m}:${s}`;
            }, 1000);
        }

        function buildNavigator() {
            navContainer.innerHTML = '';
            state.questions.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = `nav-dot ${i === 0 ? 'active' : ''}`;
                dot.textContent = i + 1;
                dot.onclick = () => jumpToQuestion(i);
                navContainer.appendChild(dot);
            });
        }

        function updateNavigator() {
            const dots = navContainer.children;
            for (let i = 0; i < dots.length; i++) {
                dots[i].classList.remove('active', 'answered', 'correct', 'wrong');
                if (i === state.currentIndex) dots[i].classList.add('active');
                if (state.answers[i]) {
                    dots[i].classList.add('answered');
                    dots[i].classList.add(state.answers[i].correct ? 'correct' : 'wrong');
                }
            }
        }

        function jumpToQuestion(index) {
            state.currentIndex = index;
            renderQuestion();
            updateNavigator();
        }

        function renderQuestion() {
            const q = state.questions[state.currentIndex];
            questionText.textContent = q.text;
            optionsContainer.innerHTML = '';
            document.getElementById('feedback-area').textContent = '';

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(idx, btn);
                
                // If already answered in review mode, show state
                if (state.answers[state.currentIndex]) {
                    btn.disabled = true;
                    if (idx === q.correctIndex) btn.classList.add('correct');
                    if (idx === state.answers[state.currentIndex].selected && !state.answers[state.currentIndex].correct) {
                        btn.classList.add('wrong');
                    }
                }
                optionsContainer.appendChild(btn);
            });
            
            progressDisplay.textContent = `${state.currentIndex + 1}/${state.questions.length}`;
        }

        function handleAnswer(selectedIndex, btnElement) {
            // Prevent multiple clicks
            if (state.answers[state.currentIndex]) return;

            const q = state.questions[state.currentIndex];
            const isCorrect = selectedIndex === q.correctIndex;
            const timeTaken = (Date.now() - state.startTime) / 1000; // Rough time, strictly needs per-question start time but simplified here
            
            state.answers[state.currentIndex] = {
                selected: selectedIndex,
                correct: isCorrect
            };

            if (isCorrect) {
                state.score += 10;
                state.coins += 5;
                playSound('correct');
                btnElement.classList.add('correct');
                spawnHearts(btnElement);
                
                // Fast answer bonus logic could go here if we tracked question start time
            } else {
                playSound('wrong');
                btnElement.classList.add('wrong');
                // Highlight correct one
                const allBtns = optionsContainer.children;
                allBtns[q.correctIndex].classList.add('correct');
            }

            updateHUD();
            updateNavigator();

            // If in Review mode, show feedback
            if (state.mode === 'study') {
                const fb = document.getElementById('feedback-area');
                fb.textContent = isCorrect ? "CORRECT! Great job!" : `WRONG! Correct answer was: ${q.options[q.correctIndex]}`;
                fb.style.color = isCorrect ? 'var(--accent-green)' : 'var(--accent-red)';
            } else {
                // Exam mode: Wait brief moment then next
                setTimeout(() => {
                    nextQuestion();
                }, 1500);
            }
        }

        function nextQuestion() {
            if (state.currentIndex < state.questions.length - 1) {
                state.currentIndex++;
                renderQuestion();
                updateNavigator();
            } else {
                endGame();
            }
        }

        function updateHUD() {
            scoreDisplay.textContent = state.score;
        }

        function spawnHearts(element) {
            const rect = element.getBoundingClientRect();
            for (let i = 0; i < 5; i++) {
                const heart = document.createElement('div');
                heart.textContent = '‚ù§Ô∏è';
                heart.className = 'bubble';
                heart.style.left = (rect.left + Math.random() * rect.width) + 'px';
                heart.style.top = rect.top + 'px';
                document.body.appendChild(heart);
                setTimeout(() => heart.remove(), 1000);
            }
        }

        function endGame() {
            clearInterval(state.timerInterval);
            showScreen('result-screen');
            
            const correctCount = state.answers.filter(a => a && a.correct).length;
            const total = state.questions.length;
            const accuracy = Math.round((correctCount / total) * 100);

            document.getElementById('final-score').textContent = state.score;
            document.getElementById('final-coins').textContent = state.coins;
            document.getElementById('accuracy').textContent = `${accuracy}%`;

            // Unlock items logic
            const unlocksDiv = document.getElementById('new-unlocks');
            const iconsDiv = document.getElementById('unlock-icons');
            iconsDiv.innerHTML = '';
            
            if (accuracy >= 50) iconsDiv.innerHTML += 'üëΩ';
            if (accuracy >= 80) iconsDiv.innerHTML += 'üèÜ';
            if (accuracy >= 100) iconsDiv.innerHTML += 'üëë';

            if (iconsDiv.innerHTML !== '') {
                unlocksDiv.style.display = 'block';
            } else {
                unlocksDiv.style.display = 'none';
            }
            
            playSound('click');
        }

        function goToStart() {
            showScreen('start-screen');
        }

        // Modal Logic
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.add('open');
        }

        function closeModal() {
            modal.classList.remove('open');
        }

        // Alien Pet Logic (Draggable)
        let isDragging = false;
        let dragOffsetX, dragOffsetY;

        alienPet.addEventListener('mousedown', startDrag);
        alienPet.addEventListener('touchstart', startDrag, {passive: false});

        function startDrag(e) {
            isDragging = true;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const rect = alienPet.getBoundingClientRect();
            dragOffsetX = clientX - rect.left;
            dragOffsetY = clientY - rect.top;
            
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchmove', onDrag, {passive: false});
            document.addEventListener('touchend', stopDrag);
        }

        function onDrag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            let x = clientX - dragOffsetX;
            let y = clientY - dragOffsetY;

            // Boundary checks
            x = Math.max(0, Math.min(window.innerWidth - 80, x));
            y = Math.max(0, Math.min(window.innerHeight - 80, y));

            alienPet.style.left = x + 'px';
            alienPet.style.top = y + 'px';
        }

        function stopDrag() {
            isDragging = false;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', stopDrag);
        }

        // Initial setup
        showScreen('start-screen');

    </script>
</body>
</html>