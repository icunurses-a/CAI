<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laboratory Final - Gold Edition</title>
<style>
    :root {
        --gold-light: #fff3b0;
        --gold-mid: #ffd700;
        --gold-dark: #b8860b;
        --deep-bg: #0f0f0f;
        --panel-bg: rgba(20, 20, 20, 0.95);
        --neon-green: #39ff14;
        --neon-red: #ff073a;
    }

    * { box-sizing: border-box; user-select: none; }

    body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--deep-bg);
        background-image: radial-gradient(circle at 50% 50%, #2a2a2a 0%, #000 100%);
        color: var(--gold-light);
        overflow-x: hidden;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* --- ANIMATIONS --- */
    @keyframes rgbFlow {
        0% { color: #ff0000; text-shadow: 0 0 10px #ff0000; }
        20% { color: #ffff00; text-shadow: 0 0 10px #ffff00; }
        40% { color: #00ff00; text-shadow: 0 0 10px #00ff00; }
        60% { color: #00ffff; text-shadow: 0 0 10px #00ffff; }
        80% { color: #0000ff; text-shadow: 0 0 10px #0000ff; }
        100% { color: #ff00ff; text-shadow: 0 0 10px #ff00ff; }
    }

    @keyframes shaky {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        10% { transform: translate(-1px, -2px) rotate(-1deg); }
        20% { transform: translate(-3px, 0px) rotate(1deg); }
        30% { transform: translate(3px, 2px) rotate(0deg); }
        40% { transform: translate(1px, -1px) rotate(1deg); }
        50% { transform: translate(-1px, 2px) rotate(-1deg); }
        60% { transform: translate(-3px, 1px) rotate(0deg); }
        70% { transform: translate(3px, 1px) rotate(-1deg); }
        80% { transform: translate(-1px, -1px) rotate(1deg); }
        90% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -2px) rotate(-1deg); }
    }

    @keyframes wave {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    @keyframes scanline {
        0% { top: -10%; }
        100% { top: 110%; }
    }

    @keyframes floatUp {
        0% { transform: translateY(0) scale(1); opacity: 1; }
        100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
    }

    /* --- LAYOUT --- */
    .scan-line {
        position: fixed;
        left: 0;
        width: 100%;
        height: 5px;
        background: var(--neon-green);
        box-shadow: 0 0 15px var(--neon-green);
        opacity: 0.5;
        animation: scanline 4s linear infinite;
        pointer-events: none;
        z-index: 999;
    }

    header {
        text-align: center;
        padding: 20px;
        z-index: 10;
    }

    h1 {
        font-size: 3rem;
        margin: 0;
        text-transform: uppercase;
        font-weight: 900;
        letter-spacing: 2px;
    }

    .title-main {
        background: linear-gradient(to bottom, var(--gold-light), var(--gold-mid));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 0 5px var(--gold-dark));
    }

    .title-final {
        display: inline-block;
        animation: shaky 0.5s infinite, rgbFlow 3s linear infinite;
        margin-left: 10px;
    }

    /* --- SETTINGS PANEL --- */
    #setup-panel {
        background: var(--panel-bg);
        border: 2px solid var(--gold-mid);
        border-radius: 15px;
        padding: 30px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.2);
        text-align: center;
        z-index: 20;
    }

    .control-group {
        margin: 20px 0;
    }

    label { font-size: 1.2rem; color: var(--gold-mid); display: block; margin-bottom: 10px; }
    
    input[type="range"] {
        width: 100%;
        accent-color: var(--gold-mid);
    }

    .btn {
        background: linear-gradient(180deg, var(--gold-mid), var(--gold-dark));
        border: 2px solid var(--gold-light);
        color: #000;
        font-weight: bold;
        padding: 15px 40px;
        font-size: 1.2rem;
        border-radius: 50px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        text-transform: uppercase;
        margin: 10px;
    }

    .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 0 20px var(--gold-mid);
    }

    .btn-secondary {
        background: #333;
        color: var(--gold-light);
        border: 1px solid var(--gold-mid);
        padding: 10px 20px;
        font-size: 1rem;
    }

    /* --- GAME INTERFACE --- */
    #game-interface {
        display: none;
        width: 95%;
        max-width: 1000px;
        flex-direction: column;
        align-items: center;
        z-index: 20;
    }

    .stats-bar {
        display: flex;
        justify-content: space-between;
        width: 100%;
        background: rgba(0,0,0,0.8);
        border: 1px solid var(--gold-dark);
        padding: 10px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        font-size: 1.2rem;
        font-weight: bold;
    }

    .stat-item { display: flex; align-items: center; gap: 10px; }
    .gold-text { color: var(--gold-mid); }

    .question-card {
        background: linear-gradient(160deg, #222, #111);
        border: 2px solid var(--gold-mid);
        border-radius: 20px;
        padding: 30px;
        width: 100%;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .q-text {
        font-size: 1.4rem;
        margin-bottom: 25px;
        line-height: 1.5;
        color: #fff;
    }

    .options-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 15px;
    }

    .option {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #444;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        font-size: 1.1rem;
    }

    .option:hover {
        background: rgba(255, 215, 0, 0.1);
        border-color: var(--gold-mid);
    }

    .option.correct {
        background: rgba(57, 255, 20, 0.2);
        border-color: var(--neon-green);
        color: var(--neon-green);
    }

    .option.wrong {
        background: rgba(255, 7, 58, 0.2);
        border-color: var(--neon-red);
        color: var(--neon-red);
    }

    /* --- NAVIGATOR --- */
    .navigator-btn {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: var(--gold-mid);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 100;
        box-shadow: 0 0 15px var(--gold-mid);
    }

    .nav-grid-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 101;
        padding: 50px;
        overflow-y: auto;
    }

    .nav-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 10px;
        max-width: 800px;
        margin: 0 auto;
    }

    .nav-item {
        width: 50px;
        height: 50px;
        border: 1px solid var(--gold-dark);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        color: var(--gold-mid);
    }
    
    .nav-item.answered-correct { background: var(--neon-green); color: #000; }
    .nav-item.answered-wrong { background: var(--neon-red); color: #fff; }

    /* --- EXTRAS --- */
    .pet-alien {
        position: absolute;
        font-size: 3rem;
        cursor: move;
        filter: drop-shadow(0 0 10px #0f0);
        z-index: 50;
        transition: transform 0.1s;
    }

    .pet-alien:active { transform: scale(1.2); }

    .bubble-heart {
        position: absolute;
        font-size: 2rem;
        color: var(--neon-red);
        animation: floatUp 1s forwards;
        pointer-events: none;
        z-index: 999;
    }

    /* --- FOOTER --- */
    footer {
        margin-top: auto;
        padding: 20px;
        width: 100%;
        text-align: center;
        background: #000;
        border-top: 1px solid var(--gold-dark);
    }

    .copyright {
        font-family: 'Courier New', monospace;
        font-size: 1.5rem;
        font-weight: bold;
        display: inline-block;
        animation: rgbFlow 4s linear infinite;
    }
    
    .wavy-char {
        display: inline-block;
        animation: wave 1s ease-in-out infinite;
    }

    /* --- RESULT MODAL --- */
    .modal {
        display: none;
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        background: var(--panel-bg);
        border: 4px solid var(--gold-mid);
        padding: 40px;
        text-align: center;
        z-index: 200;
        border-radius: 20px;
        box-shadow: 0 0 50px var(--gold-mid);
    }

    /* Explainer text */
    .explainer {
        margin-top: 15px;
        padding: 10px;
        background: rgba(255,255,255,0.1);
        border-left: 3px solid var(--gold-mid);
        font-style: italic;
        display: none;
        font-size: 0.9rem;
    }
</style>
</head>
<body>

<div class="scan-line"></div>

<header>
    <h1><span class="title-main">LABORATORY</span> <span class="title-final">FINAL</span></h1>
</header>

<div id="setup-panel">
    <h2 style="color:var(--gold-mid)">EXAM CONFIGURATION</h2>
    
    <div class="control-group">
        <label>Game Mode</label>
        <button class="btn btn-secondary" onclick="setMode('study')" id="btn-study">Study Mode (Instant Feedback)</button>
        <button class="btn btn-secondary" onclick="setMode('exam')" id="btn-exam">Exam Mode (Timed)</button>
    </div>

    <div class="control-group">
        <label>Number of Questions: <span id="q-count-disp">50</span></label>
        <input type="range" id="q-slider" min="10" max="200" value="50" oninput="updateSlider(this.value)">
    </div>

    <div class="control-group">
        <label>Extra Features</label>
        <div style="font-size: 0.9rem; color: #aaa;">Shuffle ‚Ä¢ Aliens ‚Ä¢ Coin Collection ‚Ä¢ Gold Theme</div>
    </div>

    <button class="btn" onclick="startTest()">START LAB TEST</button>
</div>

<div id="game-interface">
    <div class="stats-bar">
        <div class="stat-item">Q: <span id="current-q">1</span>/<span id="total-q">50</span></div>
        <div class="stat-item">‚è≥ <span id="timer">00:00</span></div>
        <div class="stat-item">ü™ô <span id="coins" class="gold-text">0</span></div>
        <div class="stat-item">üèÜ <span id="score">0</span></div>
        <button class="btn-secondary" style="padding: 5px 15px;" onclick="endTest()">END</button>
    </div>

    <div class="question-card" id="q-card">
        <div class="q-text" id="q-text">Loading Question...</div>
        <div class="options-grid" id="options-container">
            </div>
        <div class="explainer" id="explainer-text"></div>
        <div style="margin-top:20px; text-align:right;">
             <button class="btn-secondary" id="next-btn" onclick="nextQuestion()" style="display:none;">Next ‚û°</button>
        </div>
    </div>
</div>

<div class="navigator-btn" onclick="toggleNav()">üó∫Ô∏è</div>
<div class="nav-grid-overlay" id="nav-overlay">
    <h2 style="text-align:center; color:var(--gold-mid)">QUESTION NAVIGATOR</h2>
    <div class="nav-grid" id="nav-grid"></div>
    <div style="text-align:center; margin-top:20px;">
        <button class="btn" onclick="toggleNav()">CLOSE</button>
    </div>
</div>

<div class="modal" id="result-modal">
    <h2 class="title-final" style="font-size:2.5rem">TEST COMPLETE</h2>
    <p style="font-size:1.5rem">Score: <span id="final-score" class="gold-text"></span>%</p>
    <p>Coins Earned: <span id="final-coins"></span> ü™ô</p>
    <p id="rank-msg"></p>
    <button class="btn" onclick="location.reload()">RESTART</button>
</div>

<div class="pet-alien" id="alien1" style="top: 100px; left: 50px;">üëΩ</div>
<div class="pet-alien" id="alien2" style="top: 150px; right: 50px;">üëæ</div>

<footer>
    <div class="copyright" id="copyright"></div>
</footer>

<script>
    /* --- DATA SOURCE (Derived from Text) --- */
    const rawQuestions = [
        { q: "What is the primary function of the Immune System?", o: ["Digesting food", "Protecting against infections and foreign substances", "Regulating body temperature", "Transporting oxygen"], a: 1, e: "The immune system is responsible for protecting us against infections and foreign substances." },
        { q: "Which cell type is considered the 'First Responder' producing IgM antibodies?", o: ["T Cell", "B Cell", "Macrophage", "Plasma Cell"], a: 1, e: "IgM is the first antibody produced during an initial immune response." },
        { q: "What do Basophils and Eosinophils release to attract other immune cells?", o: ["Insulin", "Histamine", "Hemoglobin", "Adrenaline"], a: 1, e: "They release signaling and inflammatory molecules like histamine." },
        { q: "Which T cells coordinate immune responses by releasing cytokines?", o: ["Cytotoxic T cells (CD8+)", "Helper T cells (CD4+)", "Natural Killer Cells", "Memory B Cells"], a: 1, e: "Helper T cells (CD4+) coordinate responses by activating B cells and macrophages." },
        { q: "Which antibody is the most abundant in blood and provides long-term immunity?", o: ["IgM", "IgA", "IgG", "IgE"], a: 2, e: "IgG is the most abundant (~75%) and provides long-term immunity." },
        { q: "Which antibody is found in mucus, saliva, tears, and breast milk?", o: ["IgG", "IgE", "IgA", "IgM"], a: 2, e: "IgA protects mucosal surfaces and is found in secretions." },
        { q: "Which antibody increases during allergic reactions and parasitic infections?", o: ["IgD", "IgE", "IgG", "IgM"], a: 1, e: "IgE binds to mast cells and triggers histamine release during allergies." },
        { q: "What does the 'A' in the mnemonic GAMED stand for?", o: ["Allergy", "Adaptive", "At mucosal surfaces", "Antibody"], a: 2, e: "In GAMED, A stands for IgA, found At mucosal surfaces." },
        { q: "Passive natural immunity occurs when:", o: ["A person is vaccinated", "Antibodies pass from mother to fetus via placenta", "A person recovers from an infection", "White blood cells attack bacteria"], a: 1, e: "Passive natural immunity involves antibodies passing from mother to fetus/infant." },
        { q: "Which virus causes Acquired Immunodeficiency Syndrome (AIDS)?", o: ["HPV", "HIV", "Influenza", "Hepatitis B"], a: 1, e: "HIV infects CD4+ T cells leading to AIDS." },
        { q: "What is the normal lifespan of Red Blood Cells?", o: ["8-12 days", "24 hours", "120 days", "1 year"], a: 2, e: "Standard RBC lifespan is approximately 120 days (though platelets are 8-12 days)." },
        { q: "A low platelet count is known as:", o: ["Thrombocytosis", "Leukopenia", "Anemia", "Thrombocytopenia"], a: 3, e: "Thrombocytopenia is a low platelet count, risking excessive bleeding." },
        { q: "Which tube color is used for Whole Blood collected in EDTA?", o: ["Red", "Green", "Lavender", "Blue"], a: 2, e: "Lavender top tubes contain EDTA for whole blood specimens." },
        { q: "In ABO blood grouping, who is the universal donor?", o: ["Group A", "Group B", "Group AB", "Group O"], a: 3, e: "Group O cells lack A/B antigens." },
        { q: "Hemolytic Disease of the Newborn usually occurs when:", o: ["Mother is Rh+, Baby is Rh-", "Mother is Rh-, Baby is Rh+", "Both are Rh-", "Both are Rh+"], a: 1, e: "It happens when an Rh- negative mother carries an Rh+ positive baby." },
        { q: "Which rare blood phenotype lacks the H antigen?", o: ["Bombay Phenotype", "O Negative", "AB Positive", "Kell Null"], a: 0, e: "The Bombay blood group (Oh) lacks the H antigen." },
        { q: "How many pairs of chromosomes do humans normally have?", o: ["23 pairs", "46 pairs", "22 pairs", "44 pairs"], a: 0, e: "Humans have 23 pairs (46 total) chromosomes." },
        { q: "Cystic Fibrosis follows which inheritance pattern?", o: ["Autosomal Dominant", "Autosomal Recessive", "X-Linked", "Mitochondrial"], a: 1, e: "Cystic fibrosis is an Autosomal Recessive disorder." },
        { q: "What is the single most important measure to break the chain of infection?", o: ["Wearing a mask", "Hand Hygiene", "Vaccination", "Sterilization"], a: 1, e: "Hand hygiene is the single most important measure." },
        { q: "Most hospital clinical laboratories operate at which Biosafety Level?", o: ["BSL-1", "BSL-2", "BSL-3", "BSL-4"], a: 1, e: "BSL-2 is standard for most hospital labs handling moderate-risk pathogens." },
        { q: "Which mask is required for airborne precautions (e.g., TB)?", o: ["Surgical Mask", "Cloth Mask", "N95 Respirator", "Face Shield only"], a: 2, e: "An N95 respirator is required for airborne agents." },
        { q: "How long should you flush a mucous membrane exposure (splash)?", o: ["1 minute", "5 minutes", "15 minutes", "30 seconds"], a: 2, e: "Flush thoroughly with water or saline for 15 minutes." },
        { q: "HIV PEP is most effective when started within:", o: ["2 hours", "24 hours", "72 hours", "1 week"], a: 0, e: "PEP is most effective when started within 2 hours." },
        { q: "Which of the following is NOT an acceptable patient identifier?", o: ["Full Name", "Date of Birth", "Room Number", "Medical Record Number"], a: 2, e: "A patient‚Äôs room number must never be used as an identifier." },
        { q: "A throat swab is used to detect infections in the:", o: ["Lower respiratory tract", "Upper respiratory tract", "Bloodstream", "Urinary tract"], a: 1, e: "Throat swabs sample the upper respiratory tract." },
        { q: "What is the optimal puncture depth for an adult fingerstick?", o: ["1-2 mm", "2-3 mm", "4-5 mm", "Deep as possible"], a: 1, e: "Puncture depth should be 2-3 mm for adults." },
        { q: "Which antiseptic is preferred for cleaning a capillary puncture site?", o: ["Iodine", "70% Alcohol", "Hydrogen Peroxide", "Soap only"], a: 1, e: "Clean with 70% alcohol and allow to dry." },
        { q: "Why must the first drop of blood be wiped away during capillary collection?", o: ["It contains tissue fluid", "It is too dark", "It contains too much oxygen", "It is clotted"], a: 0, e: "The first drop contains tissue fluid which can dilute the sample." },
        { q: "What does POCT stand for?", o: ["Post-Operative Care Treatment", "Point-of-Care Testing", "Primary Oncology Care Team", "Patient Observed Clinical Trial"], a: 1, e: "Point-of-Care Testing." },
        { q: "Which Immunoglobulin crosses the placenta?", o: ["IgM", "IgA", "IgG", "IgE"], a: 2, e: "IgG crosses the placenta to protect the fetus." },
        { q: "Neutrophils are increased in which type of infection?", o: ["Viral", "Bacterial", "Parasitic", "Fungal"], a: 1, e: "Neutrophils increase in bacterial infections." },
        { q: "Eosinophils increase in:", o: ["Bacterial infections", "Viral infections", "Allergies and Parasites", "Tuberculosis"], a: 2, e: "Eosinophils respond to allergies and parasites." },
        { q: "What is the fluid portion of blood called?", o: ["Serum", "Plasma", "Lymph", "Water"], a: 1, e: "Blood = 55% Plasma + 45% Formed elements." },
        { q: "Which genetic mutation creates a premature stop codon?", o: ["Missense", "Nonsense", "Silent", "Frameshift"], a: 1, e: "Nonsense mutations create a premature stop codon." },
        { q: "BRCA1 mutations significantly increase the risk of:", o: ["Lung Cancer", "Breast and Ovarian Cancer", "Liver Cancer", "Leukemia"], a: 1, e: "BRCA1 is linked to Breast and Ovarian cancer risk." },
        { q: "What creates protective barriers between people and pathogens?", o: ["Biosecurity", "Biosafety", "Bioethics", "Biochemistry"], a: 1, e: "Biosafety creates protective barriers." },
        { q: "Which Hepatitis virus has no PEP available?", o: ["Hepatitis A", "Hepatitis B", "Hepatitis C", "All have PEP"], a: 2, e: "Hepatitis C has no PEP available; monitoring is required." },
        { q: "A Midstream Urine Specimen is also known as:", o: ["Dirty catch", "Clean-catch", "First void", "24-hour collection"], a: 1, e: "Midstream is known as Clean-catch." },
        { q: "CSF is collected via which procedure?", o: ["Venipuncture", "Lumbar Puncture", "Biopsy", "Thoracentesis"], a: 1, e: "CSF is collected through a lumbar puncture." },
        { q: "Who discovered the Bombay Blood Group?", o: ["Landsteiner", "Dr. Y. M. Bhende", "Pasteur", "Koch"], a: 1, e: "Discovered by Dr. Y. M. Bhende in Bombay." }
    ];

    /* --- GAME VARIABLES --- */
    let questions = [];
    let currentQIndex = 0;
    let score = 0;
    let coins = 0;
    let mode = 'study';
    let timerInterval;
    let timeElapsed = 0;
    let selectedAnswer = null;
    
    // Audio Context for Alien SFX
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playAlienSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(440, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(880, audioCtx.currentTime + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'wrong') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        } else if (type === 'alien') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.2);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.2);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.2);
        }
    }

    /* --- INITIALIZATION --- */
    function setMode(m) {
        mode = m;
        document.getElementById('btn-study').style.borderColor = m === 'study' ? 'var(--neon-green)' : 'var(--gold-mid)';
        document.getElementById('btn-exam').style.borderColor = m === 'exam' ? 'var(--neon-green)' : 'var(--gold-mid)';
    }

    function updateSlider(val) {
        document.getElementById('q-count-disp').innerText = val;
    }

    function generateCopyright() {
        const text = "AMER ALSHARIF 2026";
        const container = document.getElementById('copyright');
        container.innerHTML = '';
        [...text].forEach((char, i) => {
            const span = document.createElement('span');
            span.innerText = char === ' ' ? '\u00A0' : char;
            span.className = 'wavy-char';
            span.style.animationDelay = `${i * 0.1}s`;
            span.style.color = `hsl(${i * 20}, 100%, 50%)`;
            container.appendChild(span);
        });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    /* --- GAME LOGIC --- */
    function startTest() {
        // Setup Questions
        const qCount = parseInt(document.getElementById('q-slider').value);
        let pool = [...rawQuestions];
        
        // If requested more than available, duplicate and shuffle to simulate load
        while (pool.length < qCount) {
            pool = pool.concat(rawQuestions);
        }
        
        shuffleArray(pool);
        questions = pool.slice(0, qCount);
        
        // Reset Stats
        currentQIndex = 0;
        score = 0;
        coins = 0;
        timeElapsed = 0;
        
        // UI Switch
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('game-interface').style.display = 'flex';
        document.getElementById('total-q').innerText = questions.length;
        
        // Init Nav Grid
        const navGrid = document.getElementById('nav-grid');
        navGrid.innerHTML = '';
        questions.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = 'nav-item';
            btn.innerText = i + 1;
            btn.id = `nav-${i}`;
            btn.onclick = () => {
                // Only jump if not currently locked or in exam mode
                if (mode === 'study') {
                    currentQIndex = i;
                    loadQuestion();
                    toggleNav();
                }
            };
            navGrid.appendChild(btn);
        });

        startTimer();
        loadQuestion();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeElapsed++;
            const m = Math.floor(timeElapsed / 60).toString().padStart(2,'0');
            const s = (timeElapsed % 60).toString().padStart(2,'0');
            document.getElementById('timer').innerText = `${m}:${s}`;
        }, 1000);
    }

    function loadQuestion() {
        const q = questions[currentQIndex];
        document.getElementById('current-q').innerText = currentQIndex + 1;
        document.getElementById('q-text').innerText = q.q;
        document.getElementById('explainer-text').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        
        const container = document.getElementById('options-container');
        container.innerHTML = '';
        
        // Create options with original index tracking
        let ops = q.o.map((txt, idx) => ({ txt, idx }));
        if (mode === 'study') shuffleArray(ops); // Shuffle options only in study for fun

        ops.forEach(op => {
            const div = document.createElement('div');
            div.className = 'option';
            div.innerText = op.txt;
            div.onclick = () => checkAnswer(div, op.idx, q.a, q.e);
            container.appendChild(div);
        });
        
        selectedAnswer = null;
    }

    function checkAnswer(el, selectedIdx, correctIdx, explanation) {
        if (selectedAnswer !== null) return; // Prevent double clicking
        selectedAnswer = selectedIdx;

        const isCorrect = selectedIdx === correctIdx;
        const navItem = document.getElementById(`nav-${currentQIndex}`);

        if (isCorrect) {
            el.classList.add('correct');
            score++;
            coins += 10;
            document.getElementById('score').innerText = score;
            document.getElementById('coins').innerText = coins;
            playAlienSound('correct');
            spawnHearts(el);
            navItem.classList.add('answered-correct');
        } else {
            el.classList.add('wrong');
            playAlienSound('wrong');
            navItem.classList.add('answered-wrong');
            
            // Highlight correct answer in study mode
            if (mode === 'study') {
                const opts = document.querySelectorAll('.option');
                // Find element with correct text (since we shuffled logic is tricky, better to just show explanation)
                // Simplified: Just show explanation
            }
        }

        if (mode === 'study') {
            const expBox = document.getElementById('explainer-text');
            expBox.innerHTML = `<strong>Explanation:</strong> ${explanation}`;
            expBox.style.display = 'block';
            document.getElementById('next-btn').style.display = 'inline-block';
        } else {
            // Exam mode: Auto advance after short delay
            setTimeout(() => nextQuestion(), 1000);
        }
    }

    function spawnHearts(element) {
        const rect = element.getBoundingClientRect();
        for(let i=0; i<5; i++) {
            const heart = document.createElement('div');
            heart.innerText = "‚ù§Ô∏è"; // Bubble heart
            heart.className = 'bubble-heart';
            heart.style.left = (rect.left + Math.random() * rect.width) + 'px';
            heart.style.top = rect.top + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1000); // Remove after 1s (5s in prompt but 1s looks better for UI flow)
        }
    }

    function nextQuestion() {
        if (currentQIndex < questions.length - 1) {
            currentQIndex++;
            loadQuestion();
        } else {
            endTest();
        }
    }

    function toggleNav() {
        const nav = document.getElementById('nav-overlay');
        nav.style.display = nav.style.display === 'block' ? 'none' : 'block';
    }

    function endTest() {
        clearInterval(timerInterval);
        document.getElementById('game-interface').style.display = 'none';
        document.getElementById('result-modal').style.display = 'block';
        
        const percentage = Math.round((score / questions.length) * 100);
        document.getElementById('final-score').innerText = percentage;
        document.getElementById('final-coins').innerText = coins;
        
        let msg = "";
        if (percentage >= 90) msg = "LEGENDARY! üëΩ";
        else if (percentage >= 75) msg = "Excellent Job!";
        else msg = "Keep Studying!";
        document.getElementById('rank-msg').innerText = msg;
    }

    /* --- DRAGGABLE ALIENS --- */
    function makeDraggable(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
            playAlienSound('alien');
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

    // Init Logic
    window.onload = function() {
        generateCopyright();
        makeDraggable(document.getElementById("alien1"));
        makeDraggable(document.getElementById("alien2"));
    };

</script>
</body>
</html>