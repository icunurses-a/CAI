<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laboratory Final Exam</title>
    <style>
        :root {
            --gold: #D4AF37;
            --gold-light: #F9E295;
            --gold-dark: #AA8C2C;
            --bg-dark: #1a0f00;
            --bg-panel: #2b1d0d;
            --text-main: #FFF8E7;
            --accent-red: #8B0000;
            --accent-green: #006400;
            --font-display: 'Times New Roman', serif;
            --font-body: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 50%, #3d2a14 0%, #1a0f00 100%);
            color: var(--text-main);
            font-family: var(--font-body);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- SCAN LINE EFFECT --- */
        .scan-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, transparent, var(--gold), transparent);
            opacity: 0.5;
            z-index: 9999;
            pointer-events: none;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        /* --- HEADER & RGB EFFECTS --- */
        header {
            text-align: center;
            padding: 20px 10px;
            background: linear-gradient(to bottom, #000, transparent);
            z-index: 10;
        }

        h1 {
            font-family: var(--font-display);
            font-size: 2.2rem;
            margin: 0;
            color: var(--gold);
            text-shadow: 0 0 10px var(--gold-dark);
            text-transform: uppercase;
            letter-spacing: 2px;
            line-height: 1.2;
        }

        .final-text {
            display: inline-block;
            font-size: 3rem;
            font-weight: 900;
            animation: shake-rgb 1.5s infinite alternate;
            background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        @keyframes shake-rgb {
            0% { transform: skewX(-5deg) translateY(-2px); filter: hue-rotate(0deg); }
            25% { transform: skewX(5deg) translateY(2px); filter: hue-rotate(90deg); }
            50% { transform: skewX(-3deg) rotate(-2deg); filter: hue-rotate(180deg); }
            75% { transform: skewX(3deg) rotate(2deg); filter: hue-rotate(270deg); }
            100% { transform: skewX(-5deg) translateY(-2px); filter: hue-rotate(360deg); }
        }

        /* --- MAIN CONTAINER --- */
        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            z-index: 5;
            overflow-y: auto;
        }

        .screen {
            display: none;
            width: 100%;
            max-width: 800px;
            background: rgba(43, 29, 13, 0.95);
            border: 2px solid var(--gold);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
            animation: fadeIn 0.5s ease;
            position: relative;
            margin-bottom: 100px; /* Space for footer */
        }

        .screen.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BUTTONS & UI ELEMENTS --- */
        .btn {
            background: linear-gradient(135deg, var(--gold-dark), var(--gold));
            border: 1px solid var(--gold-light);
            color: #000;
            padding: 12px 24px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            margin: 5px;
            display: inline-block;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--gold);
        }

        .btn:active { transform: scale(0.95); }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
        }

        .btn-secondary:hover { background: rgba(212, 175, 55, 0.2); }

        .label-text { color: var(--gold); font-weight: bold; margin-bottom: 5px; display: block; }

        /* --- SETUP SCREEN --- */
        .setup-group { margin-bottom: 20px; text-align: center; }
        
        input[type="range"] {
            width: 100%;
            accent-color: var(--gold);
            height: 10px;
            background: #000;
            border-radius: 5px;
            outline: none;
        }

        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 1px solid var(--gold-dark);
            background: transparent;
            color: var(--text-main);
            cursor: pointer;
            border-radius: 5px;
        }

        .mode-btn.selected {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 10px var(--gold);
        }

        /* --- GAME SCREEN --- */
        .hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gold-dark);
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 1.1rem;
        }

        .stat-box { display: flex; align-items: center; gap: 8px; }
        .coin-icon { color: var(--gold); text-shadow: 0 0 5px orange; }

        .timer-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: var(--gold);
            width: 100%;
            transition: width 1s linear;
        }

        .question-box {
            font-size: 1.2rem;
            margin-bottom: 25px;
            line-height: 1.5;
            min-height: 60px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .option-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--gold-dark);
            padding: 15px;
            text-align: left;
            color: var(--text-main);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover { background: rgba(212, 175, 55, 0.15); border-color: var(--gold); }
        
        .option-btn.correct {
            background: var(--accent-green);
            border-color: #00ff00;
            animation: pulse-green 0.5s;
        }

        .option-btn.wrong {
            background: var(--accent-red);
            border-color: #ff0000;
            animation: shake 0.4s;
        }

        @keyframes pulse-green { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* --- NAVIGATOR --- */
        .nav-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 20px;
            justify-content: center;
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid #333;
            padding-top: 10px;
        }

        .nav-dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--gold-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            cursor: pointer;
            background: #111;
        }
        .nav-dot.current { border-color: var(--gold); box-shadow: 0 0 5px var(--gold); }
        .nav-dot.answered-correct { background: var(--accent-green); border-color: #00ff00; }
        .nav-dot.answered-wrong { background: var(--accent-red); border-color: #ff0000; }

        /* --- ALIEN PET --- */
        #alien-pet {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 80px;
            height: 80px;
            cursor: grab;
            z-index: 1000;
            filter: drop-shadow(0 0 10px var(--gold));
            transition: transform 0.1s;
            touch-action: none; /* Prevent scrolling on mobile while dragging */
        }
        #alien-pet:active { cursor: grabbing; transform: scale(1.1); }
        #alien-pet svg { width: 100%; height: 100%; fill: var(--gold); pointer-events: none; }

        /* --- FOOTER --- */
        footer {
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            z-index: 10;
            pointer-events: none;
        }

        .footer-rgb {
            font-weight: bold;
            font-size: 1.1rem;
            display: inline-block;
            animation: wavy-rgb 2s infinite linear;
            background: linear-gradient(90deg, #ff0000, #00ff00, #0000ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        @keyframes wavy-rgb {
            0% { transform: translateY(0) rotate(-2deg); filter: hue-rotate(0deg); }
            50% { transform: translateY(-5px) rotate(2deg); filter: hue-rotate(180deg); }
            100% { transform: translateY(0) rotate(-2deg); filter: hue-rotate(360deg); }
        }

        /* --- PARTICLES --- */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            font-size: 1.5rem;
            z-index: 2000;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* --- RESULTS SCREEN --- */
        .result-card {
            text-align: center;
        }
        .score-display {
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 20px var(--gold);
            margin: 20px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
        }

        /* Responsive */
        @media (max-width: 600px) {
            h1 { font-size: 1.5rem; }
            .final-text { font-size: 2.2rem; }
            .options-grid { gap: 10px; }
            .option-btn { padding: 12px; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <div class="scan-line"></div>

    <header>
        <h1>Laboratory <span class="final-text">FINAL</span></h1>
    </header>

    <main>
        <!-- SETUP SCREEN -->
        <div id="setup-screen" class="screen active">
            <h2 style="text-align: center; color: var(--gold);">Exam Configuration</h2>
            
            <div class="setup-group">
                <span class="label-text">Select Mode:</span>
                <div class="mode-toggle">
                    <div class="mode-btn selected" onclick="setMode('study')" id="mode-study">Study</div>
                    <div class="mode-btn" onclick="setMode('exam')" id="mode-exam">Exam</div>
                </div>
                <p id="mode-desc" style="font-size: 0.9rem; color: #aaa;">Review answers as you go. No time limit.</p>
            </div>

            <div class="setup-group">
                <span class="label-text">Number of Questions: <span id="q-count-val" style="color:white;">50</span></span>
                <input type="range" id="q-count-slider" min="10" max="200" value="50" oninput="updateCountDisplay(this.value)">
            </div>

            <div class="setup-group">
                <button class="btn" onclick="startGame()">Start Mission</button>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="game-screen" class="screen">
            <div class="hud">
                <div class="stat-box"><span class="coin-icon">‚óè</span> <span id="score">0</span></div>
                <div class="stat-box"><span id="q-progress">1/50</span></div>
                <div class="stat-box" id="timer-box">00:00</div>
            </div>

            <div class="timer-bar" id="timer-bar-container"><div class="timer-fill" id="timer-fill"></div></div>

            <div class="question-box" id="question-text">
                Loading question...
            </div>

            <div class="options-grid" id="options-container">
                <!-- Options injected here -->
            </div>

            <div class="nav-grid" id="nav-grid">
                <!-- Navigation dots injected here -->
            </div>
            
            <div style="text-align: center; margin-top: 15px;">
                 <button class="btn btn-secondary" onclick="endGame()">End Test</button>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div id="result-screen" class="screen">
            <div class="result-card">
                <h2>Mission Complete</h2>
                <div class="score-display" id="final-score">0%</div>
                
                <div class="stats-grid">
                    <div class="stat-item">
                        <div style="color:var(--gold)">Correct</div>
                        <div id="res-correct" style="font-size:1.5rem">0</div>
                    </div>
                    <div class="stat-item">
                        <div style="color:#ff4444">Wrong</div>
                        <div id="res-wrong" style="font-size:1.5rem">0</div>
                    </div>
                    <div class="stat-item">
                        <div style="color:#aaa">Coins Earned</div>
                        <div id="res-coins" style="font-size:1.5rem; color:var(--gold)">0</div>
                    </div>
                    <div class="stat-item">
                        <div style="color:#aaa">Time Taken</div>
                        <div id="res-time" style="font-size:1.5rem">00:00</div>
                    </div>
                </div>

                <div id="feedback-msg" style="margin-bottom: 20px; font-style: italic;"></div>

                <button class="btn" onclick="location.reload()">Play Again</button>
            </div>
        </div>
    </main>

    <!-- ALIEN PET -->
    <div id="alien-pet">
        <svg viewBox="0 0 100 100">
            <path d="M20,60 Q10,40 30,20 Q50,0 70,20 Q90,40 80,60 Q90,80 70,90 Q50,100 30,90 Q10,80 20,60 Z" />
            <circle cx="35" cy="40" r="8" fill="#000" />
            <circle cx="65" cy="40" r="8" fill="#000" />
            <ellipse cx="50" cy="60" rx="10" ry="15" fill="#AA8C2C" />
            <path d="M45,55 Q50,65 55,55" stroke="#000" stroke-width="2" fill="none" />
            <path d="M20,30 L10,10 M30,20 L20,0 M80,30 L90,10 M70,20 L80,0" stroke="#D4AF37" stroke-width="4" />
        </svg>
    </div>

    <footer>
        <span class="footer-rgb">AMER ALSHARIF 2026</span>
    </footer>

    <script>
        /* --- QUESTION BANK GENERATED FROM DOCUMENT --- */
        const rawQuestions = [
            // Immune System
            { q: "What is the primary function of the Immune System?", a: ["Digestion of food", "Pumping blood", "Protecting against infections and foreign substances", "Regulating body temperature"], c: 2 },
            { q: "Which cells are collectively known as phagocytes?", a: ["Basophils and eosinophils", "Neutrophils and macrophages", "B cells and T cells", "Erythrocytes and thrombocytes"], c: 1 },
            { q: "What do Basophils and Eosinophils release to attract other immune cells?", a: ["Histamine and inflammatory molecules", "Oxygen and nutrients", "Insulin and glucagon", "Antibodies only"], c: 0 },
            { q: "What is the role of Phagocytes?", a: ["To pump blood", "Engulf and digest harmful microorganisms and debris", "To produce antibodies", "To carry oxygen"], c: 1 },
            
            // T Cells
            { q: "Which T cells coordinate immune responses by releasing cytokines?", a: ["Cytotoxic T cells (CD8+)", "Helper T cells (CD4+)", "B cells", "Natural Killer cells"], c: 1 },
            { q: "Which cells recognize and destroy virus-infected or cancerous cells?", a: ["Helper T cells (CD4+)", "Cytotoxic T cells (CD8+)", "Basophils", "Platelets"], c: 1 },

            // Antibodies
            { q: "Which antibody is the major circulating antibody (~75%)?", a: ["IgA", "IgM", "IgG", "IgE"], c: 2 },
            { q: "Which antibody provides long-term immunity and can cross the placenta?", a: ["IgA", "IgM", "IgG", "IgD"], c: 2 },
            { q: "Which antibody is found in mucus, saliva, tears, and breast milk?", a: ["IgG", "IgA", "IgM", "IgD"], c: 1 },
            { q: "Which antibody is the 'First Responder' during initial infection?", a: ["IgG", "IgA", "IgM", "IgE"], c: 2 },
            { q: "Which antibody is excellent at agglutination (clumping pathogens)?", a: ["IgG", "IgA", "IgM", "IgE"], c: 2 },
            { q: "Which antibody is involved in allergy and parasite defense?", a: ["IgG", "IgM", "IgE", "IgD"], c: 2 },
            { q: "Which antibody binds to mast cells triggering histamine release?", a: ["IgG", "IgM", "IgE", "IgD"], c: 2 },
            { q: "Which antibody acts mainly as a B-cell receptor?", a: ["IgG", "IgD", "IgM", "IgA"], c: 1 },
            
            // Adaptive Immunity
            { q: "In naturally acquired active immunity, what enters the body?", a: ["Preformed antibodies", "Antigens naturally", "Vaccines", "Immune serum"], c: 1 },
            { q: "Which type of immunity involves antibodies passing from mother to fetus via placenta?", a: ["Naturally acquired active", "Naturally acquired passive", "Artificially acquired active", "Artificially acquired passive"], c: 1 },
            { q: "Vaccination results in which type of immunity?", a: ["Naturally acquired active", "Artificially acquired active", "Naturally acquired passive", "Artificially acquired passive"], c: 1 },
            { q: "Injection of preformed antibodies (immune serum) is an example of:", a: ["Artificially acquired passive immunity", "Artificially acquired active immunity", "Natural active immunity", "Natural passive immunity"], c: 0 },

            // HIV/AIDS
            { q: "HIV specifically infects which cells?", a: ["Red blood cells", "Platelets", "CD4+ T cells, macrophages, and dendritic cells", "Neurons"], c: 2 },
            { q: "What therapy suppresses viral replication and maintains CD4+ T cell counts?", a: ["Chemotherapy", "Antiretroviral therapy (ART)", "Radiation", "Antibiotics"], c: 1 },
            
            // Blood Basics
            { q: "What percentage of blood is plasma?", a: ["45%", "55%", "10%", "90%"], c: 1 },
            { q: "Which formed elements are included in the 45% of blood?", a: ["Water and proteins", "RBCs, WBCs, and Platelets", "Electrolytes only", "Nutrients"], c: 1 },
            { q: "What is the shape of Red Blood Cells (Erythrocytes)?", a: ["Spherical", "Biconcave", "Cuboidal", "Irregular"], c: 1 },
            
            // WBCs
            { q: "Which WBCs are Granulocytes?", a: ["Lymphocytes and Monocytes", "Neutrophils, Eosinophils, Basophils", "Platelets and RBCs", "T cells and B cells"], c: 1 },
            { q: "Which WBC is the most abundant (45-75%)?", a: ["Neutrophils", "Lymphocytes", "Eosinophils", "Monocytes"], c: 0 },
            { q: "An increase in Neutrophils is called:", a: ["Neutropenia", "Neutrophilia", "Lymphocytosis", "Eosinophilia"], c: 1 },
            { q: "Which WBCs respond to parasitic infections and allergic reactions?", a: ["Neutrophils", "Basophils", "Eosinophils", "Monocytes"], c: 2 },
            { q: "Which cells release histamine and heparin?", a: ["Eosinophils", "Neutrophils", "Basophils", "Monocytes"], c: 2 },
            { q: "Monocytes become which cells in tissues?", a: ["Neutrophils", "Macrophages", "Plasma cells", "Mast cells"], c: 1 },
            { q: "Which WBCs produce antibodies?", a: ["T cells", "B cells", "Natural Killer cells", "Monocytes"], c: 1 },
            { q: "Which WBCs provide cellular immunity (T cells)?", a: ["Lymphocytes", "Neutrophils", "Eosinophils", "Basophils"], c: 0 },
            { q: "What is Leukocytosis?", a: ["Increase in total WBC count", "Decrease in total WBC count", "Increase in RBCs", "Decrease in Platelets"], c: 0 },
            { q: "Uncontrolled proliferation of abnormal WBCs is known as:", a: ["Leukopenia", "Leukemia", "Anemia", "Thrombocytosis"], c: 1 },

            // Platelets
            { q: "What is the normal platelet count per mm¬≥?", a: ["150,000‚Äì400,000", "10,000‚Äì50,000", "500,000‚Äì1,000,000", "1,000‚Äì5,000"], c: 0 },
            { q: "What is the lifespan of platelets?", a: ["8-12 days", "120 days", "24 hours", "1 year"], c: 0 },
            { q: "Thrombocytopenia refers to:", a: ["High platelet count", "Low platelet count", "High WBC count", "Low RBC count"], c: 1 },
            
            // Blood Transfusion
            { q: "Which tube is used for collecting whole blood for hematology?", a: ["Red top", "EDTA (lavender top)", "Green top", "Blue top"], c: 1 },
            
            // Blood Groups
            { q: "Who discovered the ABO blood groups?", a: ["Landsteiner", "Pasteur", "Fleming", "Darwin"], c: 0 },
            { q: "The Rh system includes which most important antigen?", a: ["A antigen", "B antigen", "D antigen", "H antigen"], c: 2 },
            { q: "Rh antibodies are usually of which type?", a: ["IgA", "IgM", "IgG", "IgE"], c: 2 },
            { q: "Hemolytic Disease of the Newborn (Erythroblastosis Fetalis) occurs when:", a: ["Mother is Rh+, Baby is Rh-", "Mother is Rh-, Baby is Rh+", "Mother is Type O, Baby is Type A", "Father is Rh-"], c: 1 },
            { q: "What is the Bombay Blood Group also known as?", a: ["Group A", "Group B", "Oh Group", "Group O"], c: 2 },
            { q: "Individuals with Bombay blood group produce antibodies against:", a: ["A antigen only", "B antigen only", "H antigen (plus A and B)", "D antigen"], c: 2 },

            // Anticoagulants
            { q: "Who discovered Citrate-Glucose in 1916?", a: ["Rous and Turner", "Loutit and Mollison", "Gibson", "Pasteur"], c: 0 },
            { q: "Which anticoagulant contains Adenine?", a: ["ACD", "CPD", "CPDA-1", "Heparin"], c: 2 },
            { q: "How much CPDA-1 is used to preserve 100 mL of blood?", a: ["10 mL", "14 mL", "20 mL", "50 mL"], c: 1 },

            // Genetics
            { q: "How many chromosomes do humans have?", a: ["23", "46", "44", "48"], c: 1 },
            { q: "What is the difference between Genotype and Phenotype?", a: ["Genotype is physical, Phenotype is genetic", "Genotype is genetic makeup, Phenotype is observable characteristics", "They are the same", "Phenotype determines genotype"], c: 1 },
            { q: "In Autosomal Dominant inheritance, what is the risk of transmission to offspring?", a: ["25%", "50%", "100%", "0%"], c: 1 },
            { q: "Which disease follows X-linked inheritance?", a: ["Cystic fibrosis", "Hemophilia", "Huntington disease", "Sickle cell disease"], c: 1 },
            { q: "BRCA1/2 mutations follow which pattern?", a: ["Autosomal Dominant", "Autosomal Recessive", "X-Linked", "Mitochondrial"], c: 0 },
            { q: "A missense mutation results in:", a: ["A premature stop codon", "A different amino acid", "No change", "Deletion of a gene"], c: 1 },
            { q: "Why is informed consent important in genetic testing?", a: ["Ethically and psychologically", "Just for legal paperwork", "Only for billing", "It is not important"], c: 0 },

            // Infection Control
            { q: "What is the single most important measure to prevent infection spread?", a: ["Wearing gloves", "Hand hygiene", "Isolation", "Vaccination"], c: 1 },
            { q: "The Chain of Infection includes 6 elements. Breaking any link stops:", a: ["The healing process", "Transmission", "The doctor's orders", "Medication effectiveness"], c: 1 },
            { q: "What PPE is required for splash risk to eyes?", a: ["Gloves only", "Masks, Goggles/Face shield", "Gown only", "Shoe covers"], c: 1 },
            { q: "When should you wear a gown?", a: ["For all patient contact", "When splashes or extensive contact anticipated", "Only in the OR", "Never"], c: 1 },
            
            // Biosafety
            { q: "What is the purpose of Biosafety?", a: ["To decorate the lab", "To prevent exposure to biohazards", "To clean floors", "To organize files"], c: 1 },
            { q: "Most hospital clinical laboratories operate at which Biosafety Level?", a: ["BSL-1", "BSL-2", "BSL-3", "BSL-4"], c: 1 },
            { q: "Which agents are handled in BSL-4?", a: ["E. coli K-12", "Staphylococcus aureus", "Ebola, Marburg", "Influenza"], c: 2 },
            
            // Sharps & Exposure
            { q: "What is the primary purpose of Safety-Engineered Devices?", a: ["Needle stick prevention", "Cost saving", "Faster testing", "Better visibility"], c: 0 },
            { q: "After a needlestick, when is HIV PEP most effective?", a: ["Within 2 hours", "After 24 hours", "After 1 week", "Immediately after 1 month"], c: 0 },
            { q: "First aid for a mucous membrane exposure (splash to eyes):", a: ["Wash with soap", "Flush thoroughly with water/saline for 15 mins", "Apply alcohol", "Cover with bandage"], c: 1 },

            // Patient ID
            { q: "Which of the following is a valid patient identifier?", a: ["Room number", "Bed number", "Date of Birth", "Favorite color"], c: 2 },
            { q: "Patient identification must be verified before:", a: ["Cleaning the room", "Administration of medications, transfusion, and collection of specimens", "Visiting hours", "Meal time"], c: 1 },

            // Specimen Collection
            { q: "What is the most common blood sample for laboratory testing?", a: ["Venous blood", "Arterial blood", "Capillary blood", "Bone marrow"], c: 0 },
            { q: "Arterial blood is mainly used for:", a: ["CBC", "ABG analysis", "Urinalysis", "Glucose monitoring"], c: 1 },
            { q: "Midstream Clean-Catch urine is collected to:", a: ["Prevent contamination", "Increase volume", "Test for drugs only", "Save time"], c: 0 },
            { q: "Sputum is a sample from:", a: ["Lungs (coughed up)", "Kidneys", "Stomach", "Veins"], c: 0 },
            { q: "CSF is collected via:", a: ["Venipuncture", "Lumbar puncture", "Arterial stick", "Nasal swab"], c: 1 },
            { q: "Nasopharyngeal swab is an example of:", a: ["Lower respiratory specimen", "Upper respiratory specimen", "Blood specimen", "Urine specimen"], c: 1 },

            // POCT
            { q: "What does POCT stand for?", a: ["Point of Care Testing", "Patient Oriented Care Team", "Pathology Of Clinical Testing", "Point of Collection Technique"], c: 0 },
            { q: "When collecting capillary blood for glucose, the blood comes from:", a: ["Artery", "Vein", "Capillaries", "Lymph"], c: 2 },
            { q: "Why should the first drop of capillary blood be wiped away?", a: ["It is too big", "It contains tissue fluid that can affect results", "It is clotted", "It is dirty"], c: 1 },
            { q: "What is the recommended action to warm a capillary puncture site?", a: ["3-5 minutes with warm compress", "Rub vigorously with alcohol", "Apply ice", "Do not warm"], c: 0 },
            { q: "Which cardiac marker enables rapid diagnosis of acute myocardial infarction in POCT?", a: ["Glucose", "Troponin", "Hemoglobin", "INR"], c: 1 },
            { q: "Quality Assurance in POCT includes:", a: ["Daily calibration checks", "Operator competency", "Preventive maintenance", "All of the above"], c: 3 }
        ];

        // Expand to 200 questions safely
        const questionBank = [];
        for (let i = 0; i < 200; i++) {
            const original = rawQuestions[i % rawQuestions.length];
            // Create deep copy to avoid reference issues
            let qObj = {
                q: original.q,
                a: Array.isArray(original.a) ? [...original.a] : [original.a, "Option B", "Option C", "Option D"],
                c: original.c
            };
            // Ensure answer index is valid
            if (qObj.c >= qObj.a.length) qObj.c = 0;
            questionBank.push(qObj);
        }

        /* --- GAME STATE --- */
        let currentMode = 'study'; 
        let totalQuestions = 50;
        let gameQuestions = [];
        let currentQIndex = 0;
        let score = 0;
        let coins = 0;
        let userAnswers = []; 
        let timerInterval;
        let timeElapsed = 0;
        let examDuration = 60 * 60; 
        let isTimeAttack = false;
        let questionStartTime = 0;
        let audioCtx = null;

        /* --- AUDIO SYSTEM --- */
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playSound(type) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            const now = audioCtx.currentTime;

            if (type === 'click') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(300, now + 0.1);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'correct') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 0.1);
                osc.frequency.linearRampToValueAtTime(1200, now + 0.2);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'wrong') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            }
        }

        /* --- UI LOGIC --- */
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
            document.getElementById(`mode-${mode}`).classList.add('selected');
            
            const desc = document.getElementById('mode-desc');
            if (mode === 'exam') {
                desc.textContent = "Timed, shuffled questions. Immediate feedback disabled.";
                isTimeAttack = true;
            } else {
                desc.textContent = "Review answers as you go. No strict time limit.";
                isTimeAttack = false;
            }
        }

        function updateCountDisplay(val) {
            document.getElementById('q-count-val').innerText = val;
            totalQuestions = parseInt(val);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            playSound('click');
            // Prepare questions
            const shuffledBank = shuffleArray([...questionBank]);
            gameQuestions = shuffledBank.slice(0, totalQuestions);
            // Ensure answers are shuffled individually per question
            gameQuestions.forEach(q => {
                const correctText = q.a[q.c];
                q.a = shuffleArray(q.a);
                q.c = q.a.indexOf(correctText);
            });

            // Reset state
            currentQIndex = 0;
            score = 0;
            coins = 0;
            userAnswers = new Array(totalQuestions).fill(null);
            timeElapsed = 0;
            
            // Switch screens
            document.getElementById('setup-screen').classList.remove('active');
            document.getElementById('game-screen').classList.add('active');
            
            startTimer();
            renderQuestion();
            buildNavGrid();
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerBox = document.getElementById('timer-box');
            const timerFill = document.getElementById('timer-fill');
            
            timerInterval = setInterval(() => {
                timeElapsed++;
                
                const m = Math.floor(timeElapsed / 60).toString().padStart(2, '0');
                const s = (timeElapsed % 60).toString().padStart(2, '0');
                timerBox.innerText = `${m}:${s}`;

                if (isTimeAttack) {
                    const pct = 100 - (timeElapsed / examDuration * 100);
                    timerFill.style.width = `${Math.max(0, pct)}%`;
                    if (pct <= 0) endGame();
                } else {
                    timerFill.style.width = '100%'; // Full bar in study mode
                }
            }, 1000);
        }

        function renderQuestion() {
            const q = gameQuestions[currentQIndex];
            const qText = document.getElementById('question-text');
            const optsDiv = document.getElementById('options-container');
            
            document.getElementById('q-progress').innerText = `${currentQIndex + 1}/${totalQuestions}`;
            qText.innerText = q.q;
            
            optsDiv.innerHTML = '';
            
            const answered = userAnswers[currentQIndex];

            q.a.forEach((opt, idx) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.innerText = opt;
                
                btn.onclick = () => handleAnswer(idx, btn);

                if (answered !== null) {
                    btn.style.pointerEvents = 'none';
                    if (idx === q.c) btn.classList.add('correct');
                    if (answered === idx && idx !== q.c) btn.classList.add('wrong');
                }

                optsDiv.appendChild(btn);
            });

            updateNavGrid();
            questionStartTime = Date.now();
        }

        function handleAnswer(selectedIndex, btnElement) {
            if (userAnswers[currentQIndex] !== null) return;

            const q = gameQuestions[currentQIndex];
            const isCorrect = selectedIndex === q.c;
            const timeTaken = (Date.now() - questionStartTime) / 1000;

            userAnswers[currentQIndex] = selectedIndex;

            if (isCorrect) {
                playSound('correct');
                score++;
                let coinBonus = 10;
                if (timeTaken < 5) {
                    coinBonus = 20;
                    spawnHearts(btnElement);
                }
                coins += coinBonus;
                document.getElementById('score').innerText = coins;
            } else {
                playSound('wrong');
            }

            // Re-render to show colors
            const opts = document.querySelectorAll('.option-btn');
            opts.forEach((opt, idx) => {
                opt.style.pointerEvents = 'none';
                if (idx === q.c) opt.classList.add('correct');
                if (idx === selectedIndex && !isCorrect) opt.classList.add('wrong');
            });

            updateNavGrid();

            setTimeout(() => {
                if (currentQIndex < totalQuestions - 1) {
                    nextQuestion();
                } else {
                    endGame();
                }
            }, 1500);
        }

        function nextQuestion() {
            if (currentQIndex < totalQuestions - 1) {
                currentQIndex++;
                renderQuestion();
            } else {
                endGame();
            }
        }

        function spawnHearts(element) {
            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            for (let i = 0; i < 5; i++) {
                const p = document.createElement('span');
                p.className = 'particle';
                p.innerText = ['‚ù§Ô∏è', '‚ú®', '‚≠ê', 'üíñ'][Math.floor(Math.random() * 4)];
                p.style.left = (centerX + (Math.random() * 60 - 30)) + 'px';
                p.style.top = centerY + 'px';
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 1000);
            }
        }

        function buildNavGrid() {
            const grid = document.getElementById('nav-grid');
            grid.innerHTML = '';
            for (let i = 0; i < totalQuestions; i++) {
                const dot = document.createElement('div');
                dot.className = 'nav-dot';
                dot.innerText = i + 1;
                dot.onclick = () => {
                    if (currentMode === 'study') {
                        currentQIndex = i;
                        renderQuestion();
                    }
                };
                grid.appendChild(dot);
            }
        }

        function updateNavGrid() {
            const dots = document.querySelectorAll('.nav-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('current', 'answered-correct', 'answered-wrong');
                if (i === currentQIndex) dot.classList.add('current');
                if (userAnswers[i] !== null) {
                    if (userAnswers[i] === gameQuestions[i].c) dot.classList.add('answered-correct');
                    else dot.classList.add('answered-wrong');
                }
            });
        }

        function endGame() {
            clearInterval(timerInterval);
            document.getElementById('game-screen').classList.remove('active');
            document.getElementById('result-screen').classList.add('active');
            
            const correctCount = userAnswers.filter((a, i) => a !== null && a === gameQuestions[i].c).length;
            const percentage = Math.round((correctCount / totalQuestions) * 100);

            document.getElementById('final-score').innerText = `${percentage}%`;
            document.getElementById('res-correct').innerText = correctCount;
            document.getElementById('res-wrong').innerText = totalQuestions - correctCount;
            document.getElementById('res-coins').innerText = coins;
            document.getElementById('res-time').innerText = document.getElementById('timer-box').innerText;

            const msg = document.getElementById('feedback-msg');
            if (percentage >= 90) msg.innerText = "Outstanding! Galactic mastery!";
            else if (percentage >= 70) msg.innerText = "Great job! Mission Accomplished.";
            else msg.innerText = "Keep training, cadet.";
        }

        /* --- ALIEN PET INTERACTIVITY --- */
        const pet = document.getElementById('alien-pet');
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;

        pet.addEventListener('mousedown', dragStart);
        pet.addEventListener('touchstart', dragStart, {passive: false});

        function dragStart(e) {
            isDragging = true;
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            startX = clientX;
            startY = clientY;
            
            const rect = pet.getBoundingClientRect();
            initialLeft = rect.left;
            initialTop = rect.top;

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, {passive: false});
            document.addEventListener('mouseup', dragEnd);
            document.addEventListener('touchend', dragEnd);
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            
            const dx = clientX - startX;
            const dy = clientY - startY;
            
            pet.style.left = `${initialLeft + dx}px`;
            pet.style.top = `${initialTop + dy}px`;
            pet.style.bottom = 'auto';
            pet.style.right = 'auto';
        }

        function dragEnd() {
            isDragging = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('touchmove', drag);
            document.removeEventListener('mouseup', dragEnd);
            document.removeEventListener('touchend', dragEnd);
        }

        // Initialize slider
        updateCountDisplay(50);

    </script>
</body>
</html>